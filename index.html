<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Abby Kaplan">
<meta name="dcterms.date" content="2025-02-21">

<title>Nonlinear Continuous Predictors in Regression Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="nonlinear_predictors_files/libs/clipboard/clipboard.min.js"></script>
<script src="nonlinear_predictors_files/libs/quarto-html/quarto.js"></script>
<script src="nonlinear_predictors_files/libs/quarto-html/popper.min.js"></script>
<script src="nonlinear_predictors_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="nonlinear_predictors_files/libs/quarto-html/anchor.min.js"></script>
<link href="nonlinear_predictors_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="nonlinear_predictors_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="nonlinear_predictors_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="nonlinear_predictors_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="nonlinear_predictors_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="nonlinear_predictors_files/libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#linear-and-non-linear-predictors" id="toc-linear-and-non-linear-predictors" class="nav-link active" data-scroll-target="#linear-and-non-linear-predictors">Linear and non-linear predictors</a></li>
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset">Dataset</a></li>
  <li><a href="#caveats-cautions-and-notes" id="toc-caveats-cautions-and-notes" class="nav-link" data-scroll-target="#caveats-cautions-and-notes">Caveats, cautions, and notes</a></li>
  <li><a href="#linear-regression" id="toc-linear-regression" class="nav-link" data-scroll-target="#linear-regression">Linear regression</a>
  <ul class="collapse">
  <li><a href="#structure-of-predictors" id="toc-structure-of-predictors" class="nav-link" data-scroll-target="#structure-of-predictors">Structure of predictors</a></li>
  <li><a href="#fitting-the-model" id="toc-fitting-the-model" class="nav-link" data-scroll-target="#fitting-the-model">Fitting the model</a></li>
  <li><a href="#interpreting-the-age-parameter" id="toc-interpreting-the-age-parameter" class="nav-link" data-scroll-target="#interpreting-the-age-parameter">Interpreting the age parameter</a></li>
  </ul></li>
  <li><a href="#binning" id="toc-binning" class="nav-link" data-scroll-target="#binning">Binning</a>
  <ul class="collapse">
  <li><a href="#structure-of-predictors-1" id="toc-structure-of-predictors-1" class="nav-link" data-scroll-target="#structure-of-predictors-1">Structure of predictors</a></li>
  <li><a href="#fitting-the-model-1" id="toc-fitting-the-model-1" class="nav-link" data-scroll-target="#fitting-the-model-1">Fitting the model</a></li>
  <li><a href="#interpreting-the-age-parameters" id="toc-interpreting-the-age-parameters" class="nav-link" data-scroll-target="#interpreting-the-age-parameters">Interpreting the age parameters</a></li>
  <li><a href="#fitting-the-model-plus-breakpoints" id="toc-fitting-the-model-plus-breakpoints" class="nav-link" data-scroll-target="#fitting-the-model-plus-breakpoints">Fitting the model plus breakpoints</a></li>
  <li><a href="#interpreting-the-age-and-breakpoint-parameters" id="toc-interpreting-the-age-and-breakpoint-parameters" class="nav-link" data-scroll-target="#interpreting-the-age-and-breakpoint-parameters">Interpreting the age and breakpoint parameters</a></li>
  </ul></li>
  <li><a href="#piecewise-linear-regression" id="toc-piecewise-linear-regression" class="nav-link" data-scroll-target="#piecewise-linear-regression">Piecewise linear regression</a>
  <ul class="collapse">
  <li><a href="#structure-of-predictors-2" id="toc-structure-of-predictors-2" class="nav-link" data-scroll-target="#structure-of-predictors-2">Structure of predictors</a></li>
  <li><a href="#fitting-the-model-2" id="toc-fitting-the-model-2" class="nav-link" data-scroll-target="#fitting-the-model-2">Fitting the model</a></li>
  <li><a href="#interpreting-the-age-parameters-1" id="toc-interpreting-the-age-parameters-1" class="nav-link" data-scroll-target="#interpreting-the-age-parameters-1">Interpreting the age parameters</a></li>
  <li><a href="#fitting-the-model-plus-breakpoints-1" id="toc-fitting-the-model-plus-breakpoints-1" class="nav-link" data-scroll-target="#fitting-the-model-plus-breakpoints-1">Fitting the model plus breakpoints</a></li>
  <li><a href="#interpreting-the-age-and-breakpoint-parameters-1" id="toc-interpreting-the-age-and-breakpoint-parameters-1" class="nav-link" data-scroll-target="#interpreting-the-age-and-breakpoint-parameters-1">Interpreting the age and breakpoint parameters</a></li>
  </ul></li>
  <li><a href="#splines" id="toc-splines" class="nav-link" data-scroll-target="#splines">Splines</a>
  <ul class="collapse">
  <li><a href="#structure-of-predictors-3" id="toc-structure-of-predictors-3" class="nav-link" data-scroll-target="#structure-of-predictors-3">Structure of predictors</a></li>
  <li><a href="#fitting-the-model-3" id="toc-fitting-the-model-3" class="nav-link" data-scroll-target="#fitting-the-model-3">Fitting the model</a></li>
  <li><a href="#interpreting-the-age-parameters-2" id="toc-interpreting-the-age-parameters-2" class="nav-link" data-scroll-target="#interpreting-the-age-parameters-2">Interpreting the age parameters</a></li>
  </ul></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final thoughts</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Nonlinear Continuous Predictors in Regression Models</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Abby Kaplan </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 21, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="linear-and-non-linear-predictors" class="level1">
<h1>Linear and non-linear predictors</h1>
<p>This page describes some techniques for handling continuous predictors in a regression model that have a clear non-linear relationship to the outcome.</p>
<p>Sometimes, there’s a roughly linear relationship between a continuous predictor and the outcome. Linear regression is well equipped to model these cases.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>students <span class="sc">%&gt;%</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> hs.gpa, <span class="at">y =</span> gpa)) <span class="sc">+</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">fill =</span> <span class="st">"lightblue1"</span>) <span class="sc">+</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"High school GPA"</span>, <span class="at">y =</span> <span class="st">"College GPA"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Linear relationship between high school and college GPA"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"(Fake data, artificially generated)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/predictor_linear-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Other times, the relationship can be made linear with a simple transformation. For example, highly skewed predictors may have a linear relationship to the outcome after taking the log.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>income.g <span class="ot">=</span> students <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(income <span class="sc">&gt;</span> <span class="dv">10000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> income, <span class="at">y =</span> gpa)) <span class="sc">+</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">fill =</span> <span class="st">"lightblue1"</span>) <span class="sc">+</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_currency</span>(<span class="at">scale_cut =</span> scales<span class="sc">::</span><span class="fu">cut_short_scale</span>())) <span class="sc">+</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Income"</span>, <span class="at">y =</span> <span class="st">"GPA"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>log.income.g <span class="ot">=</span> students <span class="sc">%&gt;%</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(income <span class="sc">&gt;</span> <span class="dv">10000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(income), <span class="at">y =</span> gpa)) <span class="sc">+</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">fill =</span> <span class="st">"lightblue1"</span>) <span class="sc">+</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Log income"</span>, <span class="at">y =</span> <span class="st">"GPA"</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>income.g <span class="sc">+</span> log.income.g <span class="sc">+</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Linear relationship between log income and GPA"</span>,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">subtitle =</span> <span class="st">"(Fake data, artificially generated)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/predictor_log-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>But sometimes the relationship between a predictor and the outcome is nonlinear, and it’s clear that no simple transformation will make it so. This is frequently the case when the predictor is a person’s age.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>students <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> gpa)) <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">fill =</span> <span class="st">"lightblue1"</span>) <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"GPA"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Non-linear relationship between age and GPA"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"(Fake but realistic data)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/predictor_nonlinear_age-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This page presents three techniques for handling predictors like this:</p>
<ul>
<li>Binned regression</li>
<li>Piecewise linear regression</li>
<li>Spline regression</li>
</ul>
</section>
<section id="dataset" class="level1">
<h1>Dataset</h1>
<p>All of the examples on this page use a fake but realistic dataset, available as <a href="https://github.com/kaplanas/nonlinear-predictors/blob/main/fake_students.csv">fake_students.csv</a>. Available variables are as follows:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Variable name</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Planet of origin</td>
<td><code>planet</code></td>
<td>categorical</td>
</tr>
<tr class="even">
<td>Left-handed?</td>
<td><code>lefty</code></td>
<td>binary</td>
</tr>
<tr class="odd">
<td>Major</td>
<td><code>major</code></td>
<td>categorical</td>
</tr>
<tr class="even">
<td>Age</td>
<td><code>age</code></td>
<td>continuous</td>
</tr>
<tr class="odd">
<td>GPA</td>
<td><code>gpa</code></td>
<td>continuous</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>students <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">"fake_students.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">planet =</span> <span class="fu">fct_infreq</span>(planet))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">id</th>
<th style="text-align: left;">planet</th>
<th style="text-align: left;">lefty</th>
<th style="text-align: left;">major</th>
<th style="text-align: right;">age</th>
<th style="text-align: right;">gpa</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">3240</td>
<td style="text-align: left;">Jupiter</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">Marketing Management</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">3.444</td>
</tr>
<tr class="even">
<td style="text-align: right;">9170</td>
<td style="text-align: left;">Jupiter</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">Atmospheric Sciences</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0.942</td>
</tr>
<tr class="odd">
<td style="text-align: right;">14367</td>
<td style="text-align: left;">Jupiter</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">Video/Radio Production</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">2.527</td>
</tr>
<tr class="even">
<td style="text-align: right;">11093</td>
<td style="text-align: left;">Saturn</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">Music Recording Technology</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">1.303</td>
</tr>
<tr class="odd">
<td style="text-align: right;">8621</td>
<td style="text-align: left;">Jupiter</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">Music Recording Technology</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">3.939</td>
</tr>
<tr class="even">
<td style="text-align: right;">6673</td>
<td style="text-align: left;">Jupiter</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">Theatre Arts</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">2.064</td>
</tr>
<tr class="odd">
<td style="text-align: right;">15553</td>
<td style="text-align: left;">Jupiter</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">International Studies</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">1.202</td>
</tr>
<tr class="even">
<td style="text-align: right;">756</td>
<td style="text-align: left;">Jupiter</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">International Studies</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">3.581</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7911</td>
<td style="text-align: left;">Jupiter</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">Music Recording Technology</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">3.944</td>
</tr>
<tr class="even">
<td style="text-align: right;">1698</td>
<td style="text-align: left;">Jupiter</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">Engineering/Electrical</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="caveats-cautions-and-notes" class="level1">
<h1>Caveats, cautions, and notes</h1>
<p>Some of the models presented below are bad. Don’t use a modeling technique that’s clearly inappropriate for your data!</p>
<p>Even the models that are decent could use further refinement. In some of the examples below, it would be better to center age before fitting in order to avoid excessive collinearity between the intercept and the age parameter(s). For similar reasons, in the binned models, it would be better to set the baseline level of the age factor to the most frequent category instead of the first one. <em>All</em> of the models would benefit from better handling the fact that the outcome variable, GPA, is censored at 0 and 4 (see <a href="https://kaplanas.github.io/nonstandard-regression/nonstandard_regression.html">this page on nonstandard regression</a> for some options). I’ve ignored both of these issues in order to simplify the code here.</p>
<p>All of the examples below use various R libraries to fit the models. In addition, each model has an accompanying alternative implementation in Stan; Stan sometimes makes it possible to do things that aren’t available in the standard R modeling packages. All the discussion in the text refers to results from the pure R models.</p>
</section>
<section id="linear-regression" class="level1">
<h1>Linear regression</h1>
<p>Let’s start with a simple linear regression. This is obviously not a good way to handle nonlinear predictors (and it’s not why you’re here), but it will give us a baseline for comparison against better methods.</p>
<section id="structure-of-predictors" class="level2">
<h2 class="anchored" data-anchor-id="structure-of-predictors">Structure of predictors</h2>
<p>In a simple linear regression, there’s exactly one predictor associated with the <code>age</code> variable: the age itself.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/linear_predictors-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>As a result, the set of possible relationships between age and the outcome is quite limited: a straight line, whose slope is determined by the coefficient of <code>age</code>. The raw plot of age vs.&nbsp;GPA above didn’t look at all like this, which is our first hint that this model may not perform very well.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/linear_relationships-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fitting-the-model" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-model">Fitting the model</h2>
<p>We fit the model in the usual way. Besides <code>age</code>, the example below models <code>planet</code> and <code>lefty</code> as fixed effects and <code>major</code> as a random effect.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">R code</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Stan code in R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">Stan model</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb5" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>linear.m <span class="ot">=</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(gpa <span class="sc">~</span> planet <span class="sc">+</span> lefty <span class="sc">+</span> age <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> major),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> students)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linear.m)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb6" data-output-line-numbers="11" data-code-line-numbers="11"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb6-1"><a href="#cb6-1"></a>                  Estimate  Std. Error         df      t value      Pr(&gt;|t|)</span>
<span id="cb6-2"><a href="#cb6-2"></a>(Intercept)    2.677069863 0.057156837   275.7763  46.83726411 2.691279e-133</span>
<span id="cb6-3"><a href="#cb6-3"></a>planetSaturn  -0.376948800 0.024072125 16498.1549 -15.65914124  7.145621e-55</span>
<span id="cb6-4"><a href="#cb6-4"></a>planetUranus  -0.176268294 0.047266980 16449.1856  -3.72920572  1.927290e-04</span>
<span id="cb6-5"><a href="#cb6-5"></a>planetNeptune -0.127664541 0.048244308 16448.8405  -2.64620941  8.147688e-03</span>
<span id="cb6-6"><a href="#cb6-6"></a>planetEarth   -0.003787201 0.055574340 16442.8774  -0.06814657  9.456698e-01</span>
<span id="cb6-7"><a href="#cb6-7"></a>planetVenus   -0.587397870 0.058592083 16448.3863 -10.02520881  1.380412e-23</span>
<span id="cb6-8"><a href="#cb6-8"></a>planetMars    -0.461428541 0.092792182 16440.2652  -4.97270926  6.668913e-07</span>
<span id="cb6-9"><a href="#cb6-9"></a>planetMercury -0.383057815 0.127810434 16443.2029  -2.99707781  2.729880e-03</span>
<span id="cb6-10"><a href="#cb6-10"></a>leftyTRUE     -0.108893267 0.022952298 16484.4203  -4.74432954  2.109517e-06</span>
<span id="cb6-11"><a href="#cb6-11"></a>age            0.012524192 0.001446195 16433.5793   8.66010059  5.144848e-18</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the data for Stan.  Age could be included in the X matrix with all the</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># other predictors, but some things here (and in future models) are easier if we</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># keep it separate.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>linear.stan.data <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(students),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> students<span class="sc">$</span>age,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> planet <span class="sc">+</span> lefty, <span class="at">data =</span> students)[,<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">jj =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(students<span class="sc">$</span>major)),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">gpa =</span> students<span class="sc">$</span>gpa</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>linear.stan.data<span class="sc">$</span>I <span class="ot">=</span> <span class="fu">ncol</span>(linear.stan.data<span class="sc">$</span>X)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>linear.stan.data<span class="sc">$</span>J <span class="ot">=</span> <span class="fu">max</span>(linear.stan.data<span class="sc">$</span>jj)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>linear.stan <span class="ot">=</span> <span class="fu">stan</span>(<span class="st">"linear.stan"</span>, <span class="at">data =</span> linear.stan.data,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                   <span class="at">chains =</span> <span class="dv">3</span>, <span class="at">iter =</span> <span class="dv">1000</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(linear.stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"beta_age"</span>))<span class="sc">$</span>summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11,22">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb8" data-output-line-numbers="11,22" data-code-line-numbers="11,22"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb8-1"><a href="#cb8-1"></a>                 mean      se_mean          sd     n_eff      Rhat</span>
<span id="cb8-2"><a href="#cb8-2"></a>alpha     2.676885604 2.619663e-03 0.057288798  478.2429 1.0013283</span>
<span id="cb8-3"><a href="#cb8-3"></a>beta[1]  -0.376872511 4.817530e-04 0.024398547 2564.9508 0.9997136</span>
<span id="cb8-4"><a href="#cb8-4"></a>beta[2]  -0.175100239 9.019778e-04 0.045713285 2568.5805 1.0019563</span>
<span id="cb8-5"><a href="#cb8-5"></a>beta[3]  -0.127607341 8.754041e-04 0.049778738 3233.4832 0.9985246</span>
<span id="cb8-6"><a href="#cb8-6"></a>beta[4]  -0.004327524 8.097466e-04 0.055890920 4764.1369 0.9988774</span>
<span id="cb8-7"><a href="#cb8-7"></a>beta[5]  -0.586034756 9.231193e-04 0.059418226 4143.0835 0.9993759</span>
<span id="cb8-8"><a href="#cb8-8"></a>beta[6]  -0.456470065 1.344392e-03 0.092584466 4742.6832 0.9988315</span>
<span id="cb8-9"><a href="#cb8-9"></a>beta[7]  -0.377982886 2.042310e-03 0.127242041 3881.6639 0.9985172</span>
<span id="cb8-10"><a href="#cb8-10"></a>beta[8]  -0.109835182 3.591524e-04 0.022382876 3883.9561 0.9992649</span>
<span id="cb8-11"><a href="#cb8-11"></a>beta_age  0.012511228 3.383224e-05 0.001527367 2038.0987 0.9997280</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell" data-output.var="">
<div class="sourceCode cell-code" id="cb9" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of observations</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Age</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] age;</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of other predictors</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; I;</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matrix of other predictors</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N,I] X;</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of groups</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; J;</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Groups</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=J&gt; jj[N];</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Outcomes</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">4</span>&gt;[N] gpa;</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Intercept</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficient of age</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> beta_age;</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficients of other predictors</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[I] beta;</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Group-level intercepts</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[J] gamma;</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of errors</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of group-level intercepts</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_gamma;</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>  alpha ~ normal(<span class="dv">3</span>, <span class="dv">1</span>);</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>  beta_age ~ std_normal();</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>  beta ~ std_normal();</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>  gamma ~ std_normal();</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>  sigma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>  sigma_gamma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Model</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>  gpa ~ normal(alpha +</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>               (age * beta_age) +</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>               (X * beta) +</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>               (gamma[jj] * sigma_gamma),</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>               sigma);</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="interpreting-the-age-parameter" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-the-age-parameter">Interpreting the age parameter</h2>
<p>Interpreting the parameters of a simple linear regression is familiar and straightforward. The coefficient of 0.0125 for <code>age</code> means that being one year older is associated with a GPA increase of 0.0125.</p>
<p>Plotting the marginal effect of <code>age</code> is a helpful way to visualize the fitted model (and will be increasingly helpful for later models where interpreting the parameters is less straightforward). Packages like <code>margins</code> and <code>sjPlot</code> will compute and plot marginal effects automatically; the code below does this by hand. For each value of <code>age</code>, we get the predicted average GPA at that age and mean values of all other predictors in the dataset. Confidence intervals (not prediction intervals) around these estimates are constructed by sampling from the multivariate <span class="math inline">\(t\)</span> distribution of all predictors and summarizing over the samples.</p>
<p>(<code>lmerTest</code> estimates separate degrees of freedom for each fixed effect, but the <code>mvnfast::rmvt()</code> function accepts only a single value for <code>df</code>. I’ve used the smallest degrees of freedom produced by <code>lmerTest</code>, which results in confidence intervals that are slightly too conservative. For a dataset this large, we could alternatively get a close approximation by computing the variance from the multivariate normal distribution.)</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the ages we want to plot.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ages <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(students<span class="sc">$</span>age), <span class="fu">max</span>(students<span class="sc">$</span>age), <span class="fl">0.1</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a matrix of model predictors with one row per age.  All other</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># predictors are fixed at their mean values in the dataset.</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">apply</span>(<span class="fu">model.matrix</span>(linear.m), <span class="dv">2</span>, mean)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(X, <span class="fu">length</span>(ages)), <span class="at">nrow =</span> <span class="fu">length</span>(ages), <span class="at">byrow =</span> T)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>X[,<span class="fu">which</span>(<span class="fu">names</span>(<span class="fu">fixef</span>(linear.m)) <span class="sc">==</span> <span class="st">"age"</span>)] <span class="ot">=</span> ages</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the fixed-effects coefficients and their covariance matrix.</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">fixef</span>(linear.m)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>covs <span class="ot">=</span> <span class="fu">vcov</span>(linear.m)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the smallest degrees of freedom estimated by `lmerTest`.</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">min</span>(<span class="fu">summary</span>(linear.m)<span class="sc">$</span>coefficients[,<span class="st">"df"</span>])</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Run 10,000 simulations.  In each simulation, sample coefficient values from</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># the multivariate t distribution and use those to get the predicted GPA.</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate across simulations to get a mean estimate and confidence interval</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co"># for each age.</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>linear.preds <span class="ot">=</span> <span class="fu">map_dfr</span>(</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(sim) {</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    sim.coefs <span class="ot">=</span> <span class="fu">t</span>(mvnfast<span class="sc">::</span><span class="fu">rmvt</span>(<span class="dv">1</span>, coefs, covs <span class="sc">*</span> (df <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">/</span> df, df))</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">age =</span> ages,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gpa =</span> (X <span class="sc">%*%</span> sim.coefs)[,<span class="dv">1</span>]))</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"sim"</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age) <span class="sc">%&gt;%</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">lower.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.025</span>),</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">lower.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.25</span>),</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.75</span>),</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.975</span>),</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>            <span class="at">gpa =</span> <span class="fu">mean</span>(gpa),</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Model prediction"</span>)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Add observed raw means by age for plotting.</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>linear.preds <span class="ot">=</span> linear.preds <span class="sc">%&gt;%</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(students <span class="sc">%&gt;%</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(age) <span class="sc">%&gt;%</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarise</span>(<span class="at">gpa =</span> <span class="fu">mean</span>(gpa), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Raw mean"</span>))</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot model predictions and raw means.</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>linear.preds <span class="sc">%&gt;%</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> gpa, <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> students, <span class="at">color =</span> <span class="st">"gray60"</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.95</span>, <span class="at">ymax =</span> upper<span class="fl">.95</span>),</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.50</span>, <span class="at">ymax =</span> upper<span class="fl">.50</span>),</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"red4"</span>)) <span class="sc">+</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"lightblue1"</span>, <span class="cn">NA</span>),</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>                    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="fu">dsa.colors</span>(<span class="dv">3</span>), <span class="st">"white"</span>)))) <span class="sc">+</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"GPA"</span>, <span class="at">color =</span> <span class="st">""</span>, <span class="at">fill =</span> <span class="st">""</span>,</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Age as a linear predictor"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/linear_preds_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The plot makes it clear that this is not a good model; it misrepresents the relationship between age and GPA.</p>
</section>
</section>
<section id="binning" class="level1">
<h1>Binning</h1>
<p>The problem with the linear model is that different regions of the age range behave very differently. Why not group similar ages together and make each group a separate predictor?</p>
<p>This “binning” approach is easy to implement and doesn’t require any special regression techniques. All we’ve done is turned a continuous predictor into a categorical one! It’s also familiar; lots of datasets have continuous variables that are “pre-binned”. (If you’re analyzing survey data where respondents chose an age range – 21-30, 31-40, 41-50, etc. – then you’re going to use binning by necessity.)</p>
<section id="structure-of-predictors-1" class="level2">
<h2 class="anchored" data-anchor-id="structure-of-predictors-1">Structure of predictors</h2>
<p>If we create <span class="math inline">\(I\)</span> bins, the <code>age</code> variable is associated with <span class="math inline">\(I - 1\)</span> predictors. Alternatively, we could use <span class="math inline">\(I\)</span> predictors and omit the intercept from the model – again, this is all just standard procedure for a categorical variable. Each predictor has the value <code>1</code> for ages within its bin and <code>0</code> otherwise.</p>
<p><span class="math display">\[x_i(\mbox{age}) = \left\{\begin{array}{ll} 1 &amp; \mbox{if } \mbox{age} &gt; \mbox{breakpoint}_i \mbox{ and } \mbox{age} \leq \mbox{breakpoint}_{i+1} \\ 0 &amp; \mbox{otherwise} \end{array}\right.\]</span></p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/binned_predictors-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The binning approach assumes a “stepped” relationship between age and the outcome: the outcome has a constant average value within each bin, and the jump from one bin to the next can be arbitrarily large or small.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/binned_relationships-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The graph of the raw data didn’t really look like this, which is a bad sign. Let’s forge ahead and fit a binned model anyway.</p>
</section>
<section id="fitting-the-model-1" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-model-1">Fitting the model</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true" href="">R code</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false" href="">Stan code in R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false" href="">Stan model</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb11" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>binned.m <span class="ot">=</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(gpa <span class="sc">~</span> planet <span class="sc">+</span> lefty <span class="sc">+</span> age.bin <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> major),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> students <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">mutate</span>(<span class="at">age.bin =</span> <span class="fu">case_when</span>(age <span class="sc">&lt;=</span> <span class="dv">17</span> <span class="sc">~</span> <span class="st">"17 and under"</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                                                       age <span class="sc">&lt;=</span> <span class="dv">22</span> <span class="sc">~</span> <span class="st">"18-22"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                                                       age <span class="sc">&lt;=</span> <span class="dv">40</span> <span class="sc">~</span> <span class="st">"23-40"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>                                                       age <span class="sc">&lt;=</span> <span class="dv">50</span> <span class="sc">~</span> <span class="st">"41-50"</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                                                       T <span class="sc">~</span> <span class="st">"51+"</span>),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">age.bin =</span> <span class="fu">fct_reorder</span>(age.bin, age, mean)))</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(binned.m)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11-14">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb12" data-output-line-numbers="11-14" data-code-line-numbers="11-14"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb12-1"><a href="#cb12-1"></a>                 Estimate Std. Error         df     t value      Pr(&gt;|t|)</span>
<span id="cb12-2"><a href="#cb12-2"></a>(Intercept)    3.35911287 0.05281292   226.0741  63.6039988 2.904068e-146</span>
<span id="cb12-3"><a href="#cb12-3"></a>planetSaturn  -0.34787384 0.02387692 16494.6640 -14.5694625  8.702300e-48</span>
<span id="cb12-4"><a href="#cb12-4"></a>planetUranus  -0.18120576 0.04680657 16447.2416  -3.8713745  1.086417e-04</span>
<span id="cb12-5"><a href="#cb12-5"></a>planetNeptune -0.12133089 0.04776575 16446.4875  -2.5401233  1.109046e-02</span>
<span id="cb12-6"><a href="#cb12-6"></a>planetEarth   -0.04648630 0.05507632 16439.3704  -0.8440343  3.986625e-01</span>
<span id="cb12-7"><a href="#cb12-7"></a>planetVenus   -0.56578434 0.05803530 16446.4827  -9.7489686  2.142807e-22</span>
<span id="cb12-8"><a href="#cb12-8"></a>planetMars    -0.47542656 0.09187433 16438.1757  -5.1747488  2.309027e-07</span>
<span id="cb12-9"><a href="#cb12-9"></a>planetMercury -0.39072365 0.12651001 16441.3953  -3.0884801  2.015184e-03</span>
<span id="cb12-10"><a href="#cb12-10"></a>leftyTRUE     -0.06480607 0.02302287 16477.9332  -2.8148561  4.885696e-03</span>
<span id="cb12-11"><a href="#cb12-11"></a>age.bin18-22  -0.55099400 0.03244217 16487.2744 -16.9838812  3.794774e-64</span>
<span id="cb12-12"><a href="#cb12-12"></a>age.bin23-40  -0.26079523 0.03631177 16503.0196  -7.1821134  7.156992e-13</span>
<span id="cb12-13"><a href="#cb12-13"></a>age.bin41-50  -0.04890836 0.06351385 16502.2834  -0.7700424  4.412857e-01</span>
<span id="cb12-14"><a href="#cb12-14"></a>age.bin51+    -0.07061741 0.08878865 16497.0760  -0.7953427  4.264256e-01</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb13" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the data for Stan.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>students.age <span class="ot">=</span> students <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age.bin =</span> <span class="fu">case_when</span>(age <span class="sc">&lt;=</span> <span class="dv">17</span> <span class="sc">~</span> <span class="st">"17 and under"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                             age <span class="sc">&lt;=</span> <span class="dv">22</span> <span class="sc">~</span> <span class="st">"18-22"</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                             age <span class="sc">&lt;=</span> <span class="dv">40</span> <span class="sc">~</span> <span class="st">"23-40"</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                             age <span class="sc">&lt;=</span> <span class="dv">50</span> <span class="sc">~</span> <span class="st">"41-50"</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                             T <span class="sc">~</span> <span class="st">"51+"</span>),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">age.bin =</span> <span class="fu">fct_reorder</span>(age.bin, age, mean))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>binned.stan.data <span class="ot">=</span><span class="fu">list</span>(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(students.age),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> age.bin, <span class="at">data =</span> students.age)[,<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_bin =</span> students.age<span class="sc">$</span>age.bin,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> planet <span class="sc">+</span> lefty, <span class="at">data =</span> students.age)[,<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">jj =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(students.age<span class="sc">$</span>major)),</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">gpa =</span> students.age<span class="sc">$</span>gpa</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>binned.stan.data<span class="sc">$</span>I_age <span class="ot">=</span> <span class="fu">ncol</span>(binned.stan.data<span class="sc">$</span>age)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>binned.stan.data<span class="sc">$</span>I <span class="ot">=</span> <span class="fu">ncol</span>(binned.stan.data<span class="sc">$</span>X)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>binned.stan.data<span class="sc">$</span>J <span class="ot">=</span> <span class="fu">max</span>(binned.stan.data<span class="sc">$</span>jj)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>binned.stan <span class="ot">=</span> <span class="fu">stan</span>(<span class="st">"binning.stan"</span>, <span class="at">data =</span> binned.stan.data,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                   <span class="at">chains =</span> <span class="dv">3</span>, <span class="at">iter =</span> <span class="dv">1000</span>)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(binned.stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"beta_age"</span>), <span class="at">probs =</span> <span class="fu">c</span>())<span class="sc">$</span>summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11-14">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb14" data-output-line-numbers="11-14" data-code-line-numbers="11-14"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb14-1"><a href="#cb14-1"></a>                   mean      se_mean         sd    n_eff      Rhat</span>
<span id="cb14-2"><a href="#cb14-2"></a>alpha        3.35147552 0.0028971687 0.05350562  341.076 1.0062934</span>
<span id="cb14-3"><a href="#cb14-3"></a>beta[1]     -0.34703269 0.0004582582 0.02299861 2518.737 1.0016677</span>
<span id="cb14-4"><a href="#cb14-4"></a>beta[2]     -0.18029001 0.0007452131 0.04695254 3969.696 0.9986254</span>
<span id="cb14-5"><a href="#cb14-5"></a>beta[3]     -0.11999389 0.0008853894 0.04867071 3021.808 1.0000051</span>
<span id="cb14-6"><a href="#cb14-6"></a>beta[4]     -0.04555035 0.0009376941 0.05408983 3327.430 0.9993731</span>
<span id="cb14-7"><a href="#cb14-7"></a>beta[5]     -0.56398532 0.0010053610 0.05862655 3400.514 0.9999285</span>
<span id="cb14-8"><a href="#cb14-8"></a>beta[6]     -0.46877920 0.0015415830 0.09247305 3598.293 0.9987384</span>
<span id="cb14-9"><a href="#cb14-9"></a>beta[7]     -0.38719001 0.0018867222 0.12656289 4499.838 0.9989413</span>
<span id="cb14-10"><a href="#cb14-10"></a>beta[8]     -0.06540696 0.0004302421 0.02333802 2942.404 0.9997312</span>
<span id="cb14-11"><a href="#cb14-11"></a>beta_age[1] -0.54799837 0.0009642367 0.03192327 1096.093 1.0035814</span>
<span id="cb14-12"><a href="#cb14-12"></a>beta_age[2] -0.25784215 0.0011423211 0.03641412 1016.163 1.0035386</span>
<span id="cb14-13"><a href="#cb14-13"></a>beta_age[3] -0.04494017 0.0016287869 0.06353026 1521.363 1.0016375</span>
<span id="cb14-14"><a href="#cb14-14"></a>beta_age[4] -0.06541731 0.0018417186 0.08344330 2052.752 0.9998491</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<div class="cell" data-output.var="">
<div class="sourceCode cell-code" id="cb15" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of observations</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of age bins</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; I_age;</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matrix of age bins</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N,I_age] age;</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of other predictors</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; I;</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matrix of other predictors</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N,I] X;</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of groups</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; J;</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Groups</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=J&gt; jj[N];</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Outcomes</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">4</span>&gt;[N] gpa;</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Intercept</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficients of age bins</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[I_age] beta_age;</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficients of other predictors</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[I] beta;</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Group-level intercepts</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[J] base_gamma;</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of errors</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of group-level intercepts</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_gamma;</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scaled group-level intercepts.</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[J] gamma = base_gamma * sigma_gamma;</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>  alpha ~ normal(<span class="dv">3</span>, <span class="dv">1</span>);</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>  beta_age ~ std_normal();</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>  beta ~ std_normal();</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>  base_gamma ~ std_normal();</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>  sigma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>  sigma_gamma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Model</span></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>  gpa ~ normal(alpha +</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>               (age * beta_age) +</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>               (X * beta) +</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>               gamma[jj],</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>               sigma);</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="interpreting-the-age-parameters" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-the-age-parameters">Interpreting the age parameters</h2>
<p>Since binned age is just an ordinary categorical variable, there’s nothing special about interpreting the coefficients of the age bins. This model estimates that students 18-22 average a GPA 0.55 points lower than students under 18, students 23-40 average a GPA 0.26 points lower, students 41-50 average a GPA 0.05 points lower, and students 51 and older average a GPA 0.07 points lower.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the ages we want to plot and the corresponding bins.  (If not all the ages</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we want to plot are represented in the original dataframe, we have to recreate</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the bins here.)</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>ages <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(students<span class="sc">$</span>age), <span class="fu">max</span>(students<span class="sc">$</span>age), <span class="fl">0.1</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>age.bins <span class="ot">=</span> <span class="fu">case_when</span>(ages <span class="sc">&lt;=</span> <span class="dv">17</span> <span class="sc">~</span> <span class="st">"17 and under"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                     ages <span class="sc">&lt;=</span> <span class="dv">22</span> <span class="sc">~</span> <span class="st">"18-22"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                     ages <span class="sc">&lt;=</span> <span class="dv">40</span> <span class="sc">~</span> <span class="st">"23-40"</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                     ages <span class="sc">&lt;=</span> <span class="dv">50</span> <span class="sc">~</span> <span class="st">"41-50"</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>                     T <span class="sc">~</span> <span class="st">"51+"</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a matrix of model predictors with one row per age.  All other</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># predictors are fixed at their mean values in the dataset.</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">apply</span>(<span class="fu">model.matrix</span>(binned.m), <span class="dv">2</span>, mean)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(X, <span class="fu">length</span>(ages)), <span class="at">nrow =</span> <span class="fu">length</span>(ages), <span class="at">byrow =</span> T)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>X[,<span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"age.bin"</span>, <span class="fu">names</span>(<span class="fu">fixef</span>(binned.m))))] <span class="ot">=</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model.matrix</span>(<span class="sc">~</span> age.bin,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">age =</span> ages) <span class="sc">%&gt;%</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">mutate</span>(<span class="at">age.bin =</span> age.bins,</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>                        <span class="at">age.bin =</span> <span class="fu">fct_reorder</span>(age.bin, age, mean)))[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the fixed-effects coefficients and their covariance matrix.</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">fixef</span>(binned.m)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>covs <span class="ot">=</span> <span class="fu">vcov</span>(binned.m)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the smallest degrees of freedom estimated by `lmerTest`.</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">min</span>(<span class="fu">summary</span>(binned.m)<span class="sc">$</span>coefficients[,<span class="st">"df"</span>])</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Run 10,000 simulations.  In each simulation, sample coefficient values from</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="co"># the multivariate t distribution and use those to get the predicted GPA.</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate across simulations to get a mean estimate and confidence interval</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="co"># for each age.</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>binned.preds <span class="ot">=</span> <span class="fu">map_dfr</span>(</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>,</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(sim) {</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    sim.coefs <span class="ot">=</span> <span class="fu">t</span>(<span class="fu">rmvt</span>(<span class="dv">1</span>, coefs, covs <span class="sc">*</span> (df <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">/</span> df, df))</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">age =</span> ages,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>                      <span class="at">age.bin =</span> age.bins,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gpa =</span> (X <span class="sc">%*%</span> sim.coefs)[,<span class="dv">1</span>]))</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"sim"</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age, age.bin) <span class="sc">%&gt;%</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">lower.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.025</span>),</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>            <span class="at">lower.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.25</span>),</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.75</span>),</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.975</span>),</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>            <span class="at">gpa =</span> <span class="fu">mean</span>(gpa),</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Model prediction"</span>)</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Add observed raw means by age for plotting.</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>binned.preds <span class="ot">=</span> binned.preds <span class="sc">%&gt;%</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(students <span class="sc">%&gt;%</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(age) <span class="sc">%&gt;%</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarise</span>(<span class="at">gpa =</span> <span class="fu">mean</span>(gpa), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Raw mean"</span>))</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot model predictions and raw means.</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>binned.preds <span class="sc">%&gt;%</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> gpa, <span class="at">color =</span> type, <span class="at">group =</span> age.bin)) <span class="sc">+</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> students <span class="sc">%&gt;%</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>               <span class="fu">mutate</span>(<span class="at">age.bin =</span> <span class="fu">model.frame</span>(binned.m)<span class="sc">$</span>age.bin),</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"gray60"</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.95</span>, <span class="at">ymax =</span> upper<span class="fl">.95</span>),</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.50</span>, <span class="at">ymax =</span> upper<span class="fl">.50</span>),</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"red4"</span>)) <span class="sc">+</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"lightblue1"</span>, <span class="cn">NA</span>),</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>                    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="fu">dsa.colors</span>(<span class="dv">3</span>), <span class="st">"white"</span>)))) <span class="sc">+</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"GPA"</span>, <span class="at">color =</span> <span class="st">""</span>, <span class="at">fill =</span> <span class="st">""</span>,</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Age as a binned predictor"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/binned_preds_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This model is an improvement over one with age as a simple linear predictor, but it still isn’t great. This model treats students age 18-22, for example, as all the same. But it’s much more likely that the thing students in this age range have in common isn’t that they all have a similar average GPA; rather, it’s that average GPA increases sharply with age in this age range, whereas it increases more slowly with age for older students and actually <em>decreases</em> with age for younger students.</p>
</section>
<section id="fitting-the-model-plus-breakpoints" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-model-plus-breakpoints">Fitting the model plus breakpoints</h2>
<p>When we fit the binned model, we pre-specified the breakpoints between bins. But what if different breakpoints would yield a better model? It would be nice if we could include the breakpoints themselves as parameters to be estimated by the model, in addition to the cofficient for each bin.</p>
<p>The <code>segmented</code> package provides a function, <code>stepmented()</code>, that does precisely this. We specify the following arguments:</p>
<ul>
<li><code>obj</code>, a linear model (e.g., fitted with <code>lm()</code>) to which we want to add a binned continuous predictor</li>
<li><code>seg.Z</code>, a formula with the predictor(s) we want to bin</li>
<li><code>npsi</code>, the number of breakpoints we want to fit (one less than the number of bins we want)</li>
</ul>
<p>(It’s also possible to feed your own breakpoints to <code>stepmented()</code>, either as starting points for its estimation or as fixed values.)</p>
<p>The <code>stepmented()</code> function can’t handle models with random effects, but the Stan code below does.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true" href="">R code</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false" href="">Stan code in R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false" href="">Stan model</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb17" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>binned.breaks.m <span class="ot">=</span> <span class="fu">stepmented</span>(<span class="fu">lm</span>(gpa <span class="sc">~</span> planet <span class="sc">+</span> lefty,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">data =</span> students),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">seg.Z =</span> <span class="sc">~</span> age, <span class="at">npsi =</span> <span class="dv">3</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(binned.breaks.m)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11-16">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb18" data-output-line-numbers="11-16" data-code-line-numbers="11-16"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb18-1"><a href="#cb18-1"></a>                 Estimate Std. Error    t value     Pr(&gt;|t|)</span>
<span id="cb18-2"><a href="#cb18-2"></a>(Intercept)    3.30123267 0.04677875  70.571196 0.000000e+00</span>
<span id="cb18-3"><a href="#cb18-3"></a>planetSaturn  -0.37119516 0.02402114 -15.452852 8.551580e-54</span>
<span id="cb18-4"><a href="#cb18-4"></a>planetUranus  -0.20800781 0.04743023  -4.385554 5.820363e-06</span>
<span id="cb18-5"><a href="#cb18-5"></a>planetNeptune -0.13514161 0.04831464  -2.797115 2.581042e-03</span>
<span id="cb18-6"><a href="#cb18-6"></a>planetEarth   -0.06023813 0.05587028  -1.078178 1.404850e-01</span>
<span id="cb18-7"><a href="#cb18-7"></a>planetVenus   -0.59343158 0.05869372 -10.110649 2.909768e-24</span>
<span id="cb18-8"><a href="#cb18-8"></a>planetMars    -0.52599057 0.09302494  -5.654297 7.953828e-09</span>
<span id="cb18-9"><a href="#cb18-9"></a>planetMercury -0.38240449 0.12811578  -2.984835 1.420735e-03</span>
<span id="cb18-10"><a href="#cb18-10"></a>leftyTRUE     -0.07270487 0.02323543  -3.129052 8.783846e-04</span>
<span id="cb18-11"><a href="#cb18-11"></a>U1.age        -0.66481172 0.04717500 -14.092457 3.845091e-45</span>
<span id="cb18-12"><a href="#cb18-12"></a>U2.age         0.21835965 0.03707307   5.889981 1.968723e-09</span>
<span id="cb18-13"><a href="#cb18-13"></a>U3.age         0.28271132 0.02831761   9.983585 1.047789e-23</span>
<span id="cb18-14"><a href="#cb18-14"></a>psi1.age       0.00000000 0.79896715   0.000000 1.000000e+00</span>
<span id="cb18-15"><a href="#cb18-15"></a>psi2.age       0.00000000 0.70140178   0.000000 1.000000e+00</span>
<span id="cb18-16"><a href="#cb18-16"></a>psi3.age       0.00000000 0.63300735   0.000000 1.000000e+00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb19" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the data for Stan.</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>binned.breaks.stan.data <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(students),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">I_age =</span> <span class="dv">4</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> students<span class="sc">$</span>age,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> planet <span class="sc">+</span> lefty, <span class="at">data =</span> students)[,<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">jj =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(students<span class="sc">$</span>major)),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">gpa =</span> students<span class="sc">$</span>gpa</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>binned.breaks.stan.data<span class="sc">$</span>I <span class="ot">=</span> <span class="fu">ncol</span>(binned.breaks.stan.data<span class="sc">$</span>X)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>binned.breaks.stan.data<span class="sc">$</span>J <span class="ot">=</span> <span class="fu">max</span>(binned.breaks.stan.data<span class="sc">$</span>jj)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.  Breakpoints are implemented as a discrete predictor (at</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># integer values of age), similar to the changepoint model described at</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># https://mc-stan.org/docs/stan-users-guide/latent-discrete.html#change-point.section</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>binned.breaks.stan <span class="ot">=</span> <span class="fu">stan</span>(<span class="st">"src/binning_breaks.stan"</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> binned.breaks.stan.data,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>                          <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"beta_age"</span>, <span class="st">"gamma"</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"sigma"</span>, <span class="st">"sigma_gamma"</span>, <span class="st">"breakpoints"</span>),</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>                          <span class="at">chains =</span> <span class="dv">3</span>, <span class="at">iter =</span> <span class="dv">1000</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(binned.breaks.stan,</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"beta_age"</span>, <span class="st">"breakpoints"</span>),</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">probs =</span> <span class="fu">c</span>())<span class="sc">$</span>summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11-16">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb20" data-output-line-numbers="11-16" data-code-line-numbers="11-16"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb20-1"><a href="#cb20-1"></a>                      mean      se_mean         sd     n_eff      Rhat</span>
<span id="cb20-2"><a href="#cb20-2"></a>alpha           3.34848401 0.0027531956 0.05150373  349.9477 1.0061062</span>
<span id="cb20-3"><a href="#cb20-3"></a>beta[1]        -0.34624958 0.0005000690 0.02401368 2305.9903 0.9984516</span>
<span id="cb20-4"><a href="#cb20-4"></a>beta[2]        -0.18582590 0.0008907808 0.04523346 2578.5635 0.9999374</span>
<span id="cb20-5"><a href="#cb20-5"></a>beta[3]        -0.12198383 0.0010279062 0.04753100 2138.1933 0.9996211</span>
<span id="cb20-6"><a href="#cb20-6"></a>beta[4]        -0.03997517 0.0010468691 0.05492756 2752.9349 0.9983060</span>
<span id="cb20-7"><a href="#cb20-7"></a>beta[5]        -0.55685146 0.0010123198 0.05645834 3110.4318 0.9984241</span>
<span id="cb20-8"><a href="#cb20-8"></a>beta[6]        -0.47132721 0.0014766930 0.09258889 3931.3101 0.9981969</span>
<span id="cb20-9"><a href="#cb20-9"></a>beta[7]        -0.37924824 0.0021233014 0.11921189 3152.2149 0.9984037</span>
<span id="cb20-10"><a href="#cb20-10"></a>beta[8]        -0.05749851 0.0004764242 0.02361976 2457.8939 0.9981863</span>
<span id="cb20-11"><a href="#cb20-11"></a>beta_age[1]    -0.63688950 0.0011580168 0.03750385 1048.8708 1.0021973</span>
<span id="cb20-12"><a href="#cb20-12"></a>beta_age[2]    -0.44682841 0.0011409233 0.03687272 1044.4733 1.0013683</span>
<span id="cb20-13"><a href="#cb20-13"></a>beta_age[3]    -0.22172489 0.0011205530 0.03602118 1033.3588 1.0003448</span>
<span id="cb20-14"><a href="#cb20-14"></a>breakpoints[1] 18.00000000          NaN 0.00000000       NaN       NaN</span>
<span id="cb20-15"><a href="#cb20-15"></a>breakpoints[2] 19.95333333 0.0061155671 0.22328336 1333.0279 1.0013227</span>
<span id="cb20-16"><a href="#cb20-16"></a>breakpoints[3] 23.00066667          NaN 0.02581989       NaN 1.0000000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<div class="cell" data-output.var="">
<div class="sourceCode cell-code" id="cb21" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of observations</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of age bins</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; I_age;</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Array of ages</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> age[N];</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of other predictors</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; I;</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matrix of other predictors</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N,I] X;</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of groups</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; J;</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Groups</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=J&gt; jj[N];</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Outcomes</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">4</span>&gt;[N] gpa;</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of age breakpoints</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N_breakpoints = I_age - <span class="dv">1</span>;</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Limits and size of age range</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> age_min = min(age) - <span class="dv">1</span>;</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> age_max = max(age);</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> age_range = age_max - age_min;</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of possible combinations of breakpoint values (with the restriction</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// that successive breakpoints must be non-decreasing)</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N_combos = falling_factorial(age_range, N_breakpoints) / <span class="dv">2</span>;</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> log_unif = -log(N_combos);</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Breakpoint values that correspond to each element in the lp vector</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=age_range&gt; inds_bp[N_combos,N_breakpoints];</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number and indices of elements in the lp vector that correspond to each</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">// breakpoint value and age</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=N_combos&gt; N_bp_age[N_breakpoints,age_range] = rep_array(<span class="dv">0</span>, N_breakpoints, age_range);</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=N_combos&gt; inds_bp_age[N_breakpoints,age_range,N_combos] = rep_array(<span class="dv">0</span>, N_breakpoints, age_range, N_combos);</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number and indices of observations less than, or greater than or equal to,</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">// each age</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=N&gt; N_age_lt[age_range] = rep_array(<span class="dv">0</span>, age_range);</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=N&gt; N_age_ge[age_range] = rep_array(<span class="dv">0</span>, age_range);</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=N&gt; inds_age_lt[age_range,N] = rep_array(<span class="dv">0</span>, age_range, N);</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=N&gt; inds_age_ge[age_range,N] = rep_array(<span class="dv">0</span>, age_range, N);</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Populate lp indices</span></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep track of which combination of breakpoint values we're working with;</span></span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// start with all breakpoints set to 1 (= smallest age in dataset)</span></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> inds_age[N_breakpoints] = rep_array(<span class="dv">1</span>, N_breakpoints);</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Iterate over all possible combinations of breakpoint values</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span>:N_combos) {</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Iterate over breakpoints</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(b <span class="cf">in</span> <span class="dv">1</span>:N_breakpoints) {</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Record the value of this breakpoint</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>        inds_bp[i,b] = inds_age[b];</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Increment the number of elements that have this breakpoint set to</span></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">// this value</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>        N_bp_age[b,inds_age[b]] += <span class="dv">1</span>;</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add the index of this element of lp to the list of indices for this</span></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">// breakpoint set to this value</span></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>        inds_bp_age[b,inds_age[b],N_bp_age[b,inds_age[b]]] = i;</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Increment breakpoint values: increase the last breakpoint by 1, unless</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>      <span class="co">// it's already at the maximum, in which case reset the last breakpoint to</span></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 1 and increase the second-to-last breakpoint by 1, unless it's already</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>      <span class="co">// at the maximum, in which case repeat until we find a breakpoint that</span></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>      <span class="co">// can be increased</span></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(b <span class="cf">in</span> <span class="dv">1</span>:N_breakpoints) {</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> rev_b = N_breakpoints - b + <span class="dv">1</span>;</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(inds_age[rev_b] &lt; age_range) {</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>          inds_age[rev_b] += <span class="dv">1</span>;</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(rev_b &lt; N_breakpoints) {</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span>(b2 <span class="cf">in</span> (rev_b+<span class="dv">1</span>):N_breakpoints) {</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>              inds_age[b2] = inds_age[b2<span class="dv">-1</span>];</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span>;</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>          inds_age[rev_b] = <span class="dv">1</span>;</span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Populate observation age indices</span></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(age_ind <span class="cf">in</span> <span class="dv">1</span>:(age[n]-age_min)) {</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>      N_age_ge[age_ind] += <span class="dv">1</span>;</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>      inds_age_ge[age_ind,N_age_ge[age_ind]] = n;</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(age_ind <span class="cf">in</span> (age[n]-age_min+<span class="dv">1</span>):age_range) {</span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>      N_age_lt[age_ind] += <span class="dv">1</span>;</span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>      inds_age_lt[age_ind,N_age_lt[age_ind]] = n;</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Intercept</span></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficients of age bins</span></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_breakpoints] beta_age;</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficients of other predictors</span></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[I] beta;</span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Group-level intercepts</span></span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[J] base_gamma;</span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of errors</span></span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of group-level intercepts</span></span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_gamma;</span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scaled group-level intercepts</span></span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[J] gamma = base_gamma * sigma_gamma;</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>  <span class="co">// All predictors except age</span></span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] mu = alpha + (X * beta) + (gamma[jj] * sigma_gamma);</span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Accumulate log p when discrete parameters are marginalized out</span></span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_combos] lp = rep_vector(log_unif, N_combos);</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Iterate over breakpoints</span></span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(b <span class="cf">in</span> <span class="dv">1</span>:N_breakpoints) {</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Iterate over possible values the breakpoint might have</span></span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(a <span class="cf">in</span> <span class="dv">1</span>:age_range) {</span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Useful counts and indices stored above</span></span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> N_b = N_bp_age[b,a];</span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> b_inds[N_b] = inds_bp_age[b,a,<span class="dv">1</span>:N_b];</span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> N_lt = N_age_lt[a];</span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> N_ge = N_age_ge[a];</span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> ge_inds[N_ge] = inds_age_ge[a,<span class="dv">1</span>:N_ge];</span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>      <span class="co">// If this is the first breakpoint and its value is greater than the</span></span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>      <span class="co">// smallest age, all observations with a smaller age get mu with no age-</span></span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>      <span class="co">// related parameters</span></span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(b == <span class="dv">1</span> &amp;&amp; N_lt &gt; <span class="dv">0</span>) {</span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> lt_inds[N_lt] = inds_age_lt[a,<span class="dv">1</span>:N_lt];</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a>        lp[b_inds] += normal_lpdf(gpa[lt_inds] | mu[lt_inds], sigma);</span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>      <span class="co">// All observations with an age greater than or equal to this breakpoint's</span></span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>      <span class="co">// value get mu plus the age parameter corresponding to this brekapoint</span></span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>      lp[b_inds] += normal_lpdf(gpa[ge_inds] | mu[ge_inds] + beta_age[b], sigma);</span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a>      <span class="co">// If this is not the first breakpoint, subtract the effect of the</span></span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a>      <span class="co">// previous breakpoint</span></span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(b &gt; <span class="dv">1</span>) {</span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a>        lp[b_inds] -= normal_lpdf(gpa[ge_inds] | mu[ge_inds] + beta_age[b<span class="dv">-1</span>], sigma);</span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a>  alpha ~ normal(<span class="dv">3</span>, <span class="dv">1</span>);</span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a>  beta_age ~ std_normal();</span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a>  beta ~ std_normal();</span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a>  base_gamma ~ std_normal();</span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a>  sigma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a>  sigma_gamma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Model</span></span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> log_sum_exp(lp);</span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb21-195"><a href="#cb21-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-196"><a href="#cb21-196" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Breakpoints</span></span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=age_min+<span class="dv">1</span>,<span class="kw">upper</span>=age_max&gt; breakpoints[N_breakpoints];</span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> lp_ind = categorical_logit_rng(lp);</span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(b <span class="cf">in</span> <span class="dv">1</span>:N_breakpoints) {</span>
<span id="cb21-201"><a href="#cb21-201" aria-hidden="true" tabindex="-1"></a>      breakpoints[b] = age_min + inds_bp[lp_ind,b];</span>
<span id="cb21-202"><a href="#cb21-202" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-203"><a href="#cb21-203" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-204"><a href="#cb21-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-205"><a href="#cb21-205" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>The coefficients of the age bins in this model are named <code>U[integer].age</code> by the <code>stepmented()</code> function. The model additionally fits a parameter for each breakpoint; these are named <code>psi[integer].age</code>. Surprisingly, the <code>summary()</code> of a fitted model shows standard errors for these parameters but not their estimated values. We can find the estimated values in <code>binned.breaks.m$psi</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>binned.breaks.m<span class="sc">$</span>psi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>         Initial     Est.    St.Err
psi1.age      NA 17.19766 0.7989671
psi2.age      NA 19.22244 0.7014018
psi3.age      NA 22.56875 0.6330074</code></pre>
</div>
</div>
</section>
<section id="interpreting-the-age-and-breakpoint-parameters" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-the-age-and-breakpoint-parameters">Interpreting the age and breakpoint parameters</h2>
<p>The coefficients for the age bins are the same as they were in the model with fixed breakpoints, with one difference: <code>stepmented()</code> represents each coefficient as the difference between the mean for that bin and the mean for the previous bin, not the difference between the mean for that bin and the overall intercept.</p>
<p><span class="math display">\[x_i(\mbox{age}) = \left\{\begin{array}{ll} 1 &amp; \mbox{if } \mbox{age} &gt; \mbox{breakpoint}_i \\ 0 &amp; \mbox{otherwise} \end{array}\right.\]</span></p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/binned_predictors_2-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The fitted model estimates that students in the second-lowest age bin have an average GPA 0.66 points lower than students in the lowest age bin, students in the third-lowest age bin have an average GPA 0.22 points higher than students in the second-lowest age bin, and so on.</p>
<p>This difference-from-the-previous-bin model isn’t a requirement of fitting a model that estimates breakpoints; it’s just the way <code>segmented()</code> does things. The alternative Stan code above models intercepts using the difference-from-the-intercept approach.</p>
<p>The model estimates breakpoints at ages 17.2, 19.22, and 22.57, but with some uncertainty:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>binned.breaks.m<span class="sc">$</span>psi <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">se =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(binned.breaks.m)[<span class="fu">grepl</span>(<span class="st">"psi"</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                                                    <span class="fu">names</span>(<span class="fu">coef</span>(binned.breaks.m))),<span class="fu">grepl</span>(<span class="st">"psi"</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                                                                                        <span class="fu">names</span>(<span class="fu">coef</span>(binned.breaks.m)))]))) <span class="sc">%&gt;%</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"i"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"^psi"</span>, i)) <span class="sc">%&gt;%</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">i =</span> <span class="fu">gsub</span>(<span class="st">"^psi([0-9]+).age$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, i),</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">i =</span> <span class="fu">as.factor</span>(<span class="fu">as.numeric</span>(i)),</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">lower.95 =</span> Est. <span class="sc">+</span> (<span class="fu">qnorm</span>(<span class="fl">0.025</span>) <span class="sc">*</span> se),</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">lower.50 =</span> Est. <span class="sc">+</span> (<span class="fu">qnorm</span>(<span class="fl">0.25</span>) <span class="sc">*</span> se),</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper.50 =</span> Est. <span class="sc">+</span> (<span class="fu">qnorm</span>(<span class="fl">0.75</span>) <span class="sc">*</span> se),</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper.95 =</span> Est. <span class="sc">+</span> (<span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> se)) <span class="sc">%&gt;%</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">fct_rev</span>(i))) <span class="sc">+</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower<span class="fl">.95</span>, <span class="at">xmax =</span> upper<span class="fl">.95</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower<span class="fl">.50</span>, <span class="at">xmax =</span> upper<span class="fl">.50</span>), <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> Est.), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(students<span class="sc">$</span>age)) <span class="sc">+</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Estimated value"</span>, <span class="at">y =</span> <span class="st">"Breakpoint"</span>, <span class="at">color =</span> <span class="st">"Breakpoint"</span>,</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Breakpoint"</span>) <span class="sc">+</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/binned_breaks_breakpoints-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>When we plot the fitted values of the model at various ages, we get a surprise: it looks like the model has curves! This is because there’s uncertainty around the locations of the breakpoints. The gradual decrease between ages 16 and 18, for example, does <em>not</em> mean that the model predicts a gradual decline in GPA during those years. Rather, the model predicts a <em>sharp</em> decrease at some point (because that’s how binning works); the gradual decline represents the fact that the model isn’t sure <em>where</em> that sharp decrease is. We can also see this uncertainty in the fact that the confidence bands around the predictions increase dramatically at the boundaries between bins.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the ages we want to plot.</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>ages <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(students<span class="sc">$</span>age), <span class="fu">max</span>(students<span class="sc">$</span>age), <span class="fl">0.1</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a matrix of model predictors with one row per age.  All other</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># predictors are fixed at their mean values in the dataset.</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">apply</span>(<span class="fu">model.matrix</span>(binned.breaks.m), <span class="dv">2</span>, mean)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> X[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"age$"</span>, <span class="fu">names</span>(X))]</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(X, <span class="fu">length</span>(ages)), <span class="at">nrow =</span> <span class="fu">length</span>(ages), <span class="at">byrow =</span> T)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the parameters and their covariance matrix.  Note which parameters are for</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># breakpoints (as opposed to being coefficients for predictors).</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">coef</span>(binned.breaks.m)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>covs <span class="ot">=</span> <span class="fu">vcov</span>(binned.breaks.m)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>breakpoint.ind <span class="ot">=</span> <span class="fu">grepl</span>(<span class="st">"^psi"</span>, <span class="fu">names</span>(coefs))</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>coefs[breakpoint.ind] <span class="ot">=</span> binned.breaks.m<span class="sc">$</span>psi[,<span class="st">"Est."</span>]</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the degrees of freedom.</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> binned.breaks.m<span class="sc">$</span>df.residual</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Run 10,000 simulations.  In each simulation, sample parameter values from</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co"># the multivariate t distribution and use those to get the predicted GPA.  Note</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co"># that we have to determine age bins separately for each simulation.</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate across simulations to get a mean estimate and confidence interval</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="co"># for each age.</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>binned.breaks.preds <span class="ot">=</span> <span class="fu">map_dfr</span>(</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>,</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(sim) {</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    sim.coefs <span class="ot">=</span> <span class="fu">t</span>(<span class="fu">rmvt</span>(<span class="dv">1</span>, coefs, covs <span class="sc">*</span> (df <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">/</span> df, df))</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    sim.breakpoints <span class="ot">=</span> <span class="fu">cummax</span>(sim.coefs[breakpoint.ind])</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    sim.X <span class="ot">=</span> <span class="fu">cbind</span>(X,</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">do.call</span>(</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"cbind"</span>,</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">lapply</span>(sim.breakpoints, <span class="cf">function</span>(b) { ages <span class="sc">&gt;</span> b })</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>                  ))</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">age =</span> ages,</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gpa =</span> (sim.X <span class="sc">%*%</span> sim.coefs[<span class="sc">!</span>breakpoint.ind])[,<span class="dv">1</span>]))</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"sim"</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age) <span class="sc">%&gt;%</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">lower.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.025</span>),</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>            <span class="at">lower.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.25</span>),</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.75</span>),</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.975</span>),</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>            <span class="at">gpa =</span> <span class="fu">mean</span>(gpa),</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Model prediction"</span>)</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Add observed raw means by age for plotting.</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>binned.breaks.preds <span class="ot">=</span> binned.breaks.preds <span class="sc">%&gt;%</span></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(students <span class="sc">%&gt;%</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(age) <span class="sc">%&gt;%</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarise</span>(<span class="at">gpa =</span> <span class="fu">mean</span>(gpa), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Raw mean"</span>))</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot model predictions and raw means.</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>binned.breaks.preds <span class="sc">%&gt;%</span></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> gpa, <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> students,</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"gray60"</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.95</span>, <span class="at">ymax =</span> upper<span class="fl">.95</span>),</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.50</span>, <span class="at">ymax =</span> upper<span class="fl">.50</span>),</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"red4"</span>)) <span class="sc">+</span></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"lightblue1"</span>, <span class="cn">NA</span>),</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>                    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="fu">dsa.colors</span>(<span class="dv">3</span>), <span class="st">"white"</span>)))) <span class="sc">+</span></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"GPA"</span>, <span class="at">color =</span> <span class="st">""</span>, <span class="at">fill =</span> <span class="st">""</span>,</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Age as a binned predictor with estimated breakpoints"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/binned_breaks_preds_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Full disclosure: some of the summaries above are a lie. In reality, <code>stepmented()</code> encounters severe model-fitting problems on this particular dataset – which yet another indication that, even with breakpoints estimated by the model itself, binning is not the best model here. Because of these problems, <code>stepmented()</code> refuses to provide the usual summary information via <code>summary()</code> and other functions. It’s possible to get some of the model’s estimates in other ways, which is how I created the graphs above, but the model is giving us big flashing warnings that these estimates are <em>not</em> reliable. (This is also why this example uses only three breakpoints; if we try to fit four breakpoints, the problems are even worse and <code>stepmented()</code> won’t return anything at all.)</p>
</section>
</section>
<section id="piecewise-linear-regression" class="level1">
<h1>Piecewise linear regression</h1>
<p>Binning seems like the wrong approach for this dataset; we don’t see the sharp jumps between bins that are inherent to the binning model. A more promising approach is piecewise linear regression, where different ranges of the predictor can have different slopes.</p>
<section id="structure-of-predictors-2" class="level2">
<h2 class="anchored" data-anchor-id="structure-of-predictors-2">Structure of predictors</h2>
<p>In piecewise linear regression, we divide the <code>age</code> variable into <span class="math inline">\(I\)</span> segments, each of which is associated with its own predictor. The predictor for a given segment has the value <code>0</code> for ages below the bottom of the segment, increases linearly throughout the segment, and tops out at its maximum value for all ages above the top of the segment. This means that the coefficient for each predictor tells us the slope of the outcome relative to <code>age</code> within that range; setting each predictor to its maximum value for larger ages ensures that all the linear pieces connect at the breakpoints.</p>
<p><span class="math display">\[x_i(\mbox{age}) = \left\{\begin{array}{ll} 0 &amp; \mbox{if } \mbox{age} \leq \mbox{breakpoint}_i \\ \mbox{age} - \mbox{breakpoint}_i &amp; \mbox{if } \mbox{age} &gt; \mbox{breakpoint}_i \mbox{ and } \mbox{age} \leq \mbox{breakpoint}_{i+1} \\ \mbox{breakpoint}_{i+1} - \mbox{breakpoint}_i &amp; \mbox{otherwise} \end{array}\right.\]</span></p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/piecewise_predictors-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Unlike the “stepped” look of a binned model, a piecewise linear model assumes that there are no discontinuous jumps in the outcome from one age to the next. However, the effect of age can be as large or as small as necessary within each segment.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/piecewise_relationships-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fitting-the-model-2" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-model-2">Fitting the model</h2>
<p>It’s straightforward to compute the piecewise predictors and include them in an ordinary linear regression.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true" href="">R code</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false" href="">Stan code in R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false" href="">Stan model</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb26" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>piecewise.m <span class="ot">=</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(gpa <span class="sc">~</span> planet <span class="sc">+</span> lefty <span class="sc">+</span> age<span class="fl">.18</span> <span class="sc">+</span> age.<span class="fl">18.23</span> <span class="sc">+</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                               age.<span class="fl">23.45</span> <span class="sc">+</span> age<span class="fl">.45</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> major),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> students <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">mutate</span>(<span class="at">age.18 =</span> <span class="fu">pmin</span>(age, <span class="dv">18</span>),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">age.18.23 =</span> <span class="fu">if_else</span>(age <span class="sc">&lt;=</span> <span class="dv">18</span>, <span class="dv">0</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>                                                          <span class="fu">pmin</span>(age, <span class="dv">23</span>) <span class="sc">-</span> <span class="dv">18</span>),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">age.23.45 =</span> <span class="fu">if_else</span>(age <span class="sc">&lt;=</span> <span class="dv">23</span>, <span class="dv">0</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>                                                          <span class="fu">pmin</span>(age, <span class="dv">45</span>) <span class="sc">-</span> <span class="dv">23</span>),</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">age.45 =</span> <span class="fu">if_else</span>(age <span class="sc">&lt;=</span> <span class="dv">45</span>, <span class="dv">0</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>                                                       age <span class="sc">-</span> <span class="dv">45</span>)))</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(piecewise.m)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11-14">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb27" data-output-line-numbers="11-14" data-code-line-numbers="11-14"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb27-1"><a href="#cb27-1"></a>                  Estimate  Std. Error       df     t value      Pr(&gt;|t|)</span>
<span id="cb27-2"><a href="#cb27-2"></a>(Intercept)    8.183978004 0.358811473 16222.50  22.8085739 2.273225e-113</span>
<span id="cb27-3"><a href="#cb27-3"></a>planetSaturn  -0.348202137 0.023963184 16495.16 -14.5307126  1.522352e-47</span>
<span id="cb27-4"><a href="#cb27-4"></a>planetUranus  -0.177841380 0.046921396 16446.59  -3.7901980  1.510644e-04</span>
<span id="cb27-5"><a href="#cb27-5"></a>planetNeptune -0.123314189 0.047890526 16446.57  -2.5749182  1.003504e-02</span>
<span id="cb27-6"><a href="#cb27-6"></a>planetEarth   -0.042091944 0.055245549 16439.03  -0.7619065  4.461267e-01</span>
<span id="cb27-7"><a href="#cb27-7"></a>planetVenus   -0.564880559 0.058187535 16446.51  -9.7079307  3.200083e-22</span>
<span id="cb27-8"><a href="#cb27-8"></a>planetMars    -0.471094998 0.092111648 16438.01  -5.1143912  3.182925e-07</span>
<span id="cb27-9"><a href="#cb27-9"></a>planetMercury -0.395643963 0.126872467 16441.21  -3.1184383  1.821261e-03</span>
<span id="cb27-10"><a href="#cb27-10"></a>leftyTRUE     -0.081480577 0.022975290 16478.30  -3.5464439  3.915514e-04</span>
<span id="cb27-11"><a href="#cb27-11"></a>age.18        -0.301861841 0.020193192 16455.66 -14.9486937  3.391479e-50</span>
<span id="cb27-12"><a href="#cb27-12"></a>age.18.23      0.054507352 0.006414832 16499.01   8.4970811  2.108056e-17</span>
<span id="cb27-13"><a href="#cb27-13"></a>age.23.45      0.012425265 0.002603505 16501.32   4.7725148  1.834986e-06</span>
<span id="cb27-14"><a href="#cb27-14"></a>age.45        -0.006129058 0.009952534 16505.00  -0.6158289  5.380159e-01</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb28" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the data for Stan.</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>piecewise.stan.data <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(students),</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> age<span class="fl">.18</span> <span class="sc">+</span> age.<span class="fl">18.23</span> <span class="sc">+</span> age.<span class="fl">23.45</span> <span class="sc">+</span> age<span class="fl">.45</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> students <span class="sc">%&gt;%</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">mutate</span>(<span class="at">age.18 =</span> <span class="fu">pmin</span>(age, <span class="dv">18</span>),</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">age.18.23 =</span> <span class="fu">if_else</span>(age <span class="sc">&lt;=</span> <span class="dv">18</span>, <span class="dv">0</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>                                                  <span class="fu">pmin</span>(age, <span class="dv">23</span>) <span class="sc">-</span> <span class="dv">18</span>),</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>                              <span class="at">age.23.45 =</span> <span class="fu">if_else</span>(age <span class="sc">&lt;=</span> <span class="dv">23</span>, <span class="dv">0</span>,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>                                                  <span class="fu">pmin</span>(age, <span class="dv">45</span>) <span class="sc">-</span> <span class="dv">23</span>),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>                              <span class="at">age.45 =</span> <span class="fu">if_else</span>(age <span class="sc">&lt;=</span> <span class="dv">45</span>, <span class="dv">0</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>                                               age <span class="sc">-</span> <span class="dv">45</span>)))[,<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> planet <span class="sc">+</span> lefty, <span class="at">data =</span> students)[,<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">jj =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(students<span class="sc">$</span>major)),</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">gpa =</span> students<span class="sc">$</span>gpa</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>piecewise.stan.data<span class="sc">$</span>I_age <span class="ot">=</span> <span class="fu">ncol</span>(piecewise.stan.data<span class="sc">$</span>age)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>piecewise.stan.data<span class="sc">$</span>I <span class="ot">=</span> <span class="fu">ncol</span>(piecewise.stan.data<span class="sc">$</span>X)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>piecewise.stan.data<span class="sc">$</span>J <span class="ot">=</span> <span class="fu">max</span>(piecewise.stan.data<span class="sc">$</span>jj)</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>piecewise.stan <span class="ot">=</span> <span class="fu">stan</span>(<span class="st">"piecewise.stan"</span>, <span class="at">data =</span> piecewise.stan.data,</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>                      <span class="at">chains =</span> <span class="dv">3</span>, <span class="at">iter =</span> <span class="dv">1000</span>)</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(piecewise.stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"beta_age"</span>),</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">probs =</span> <span class="fu">c</span>())<span class="sc">$</span>summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11-14">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb29" data-output-line-numbers="11-14" data-code-line-numbers="11-14"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb29-1"><a href="#cb29-1"></a>                    mean      se_mean          sd    n_eff      Rhat</span>
<span id="cb29-2"><a href="#cb29-2"></a>alpha        7.600405523 7.754200e-03 0.339993008 1922.498 1.0003911</span>
<span id="cb29-3"><a href="#cb29-3"></a>beta[1]     -0.348919918 4.115698e-04 0.023426392 3239.842 0.9987769</span>
<span id="cb29-4"><a href="#cb29-4"></a>beta[2]     -0.176581665 8.526566e-04 0.048161638 3190.466 0.9998149</span>
<span id="cb29-5"><a href="#cb29-5"></a>beta[3]     -0.121374010 8.141008e-04 0.048328140 3524.064 0.9997066</span>
<span id="cb29-6"><a href="#cb29-6"></a>beta[4]     -0.035933411 7.656053e-04 0.052844167 4764.137 0.9984282</span>
<span id="cb29-7"><a href="#cb29-7"></a>beta[5]     -0.562752450 9.997033e-04 0.058254627 3395.616 0.9985756</span>
<span id="cb29-8"><a href="#cb29-8"></a>beta[6]     -0.463644470 1.569735e-03 0.087994538 3142.379 0.9998075</span>
<span id="cb29-9"><a href="#cb29-9"></a>beta[7]     -0.385604297 2.478203e-03 0.127701936 2655.346 0.9984740</span>
<span id="cb29-10"><a href="#cb29-10"></a>beta[8]     -0.085810751 3.524674e-04 0.022216881 3973.088 0.9980786</span>
<span id="cb29-11"><a href="#cb29-11"></a>beta_age[1] -0.269366726 4.363992e-04 0.019284819 1952.824 0.9999700</span>
<span id="cb29-12"><a href="#cb29-12"></a>beta_age[2]  0.051488169 1.292064e-04 0.006213024 2312.266 1.0004762</span>
<span id="cb29-13"><a href="#cb29-13"></a>beta_age[3]  0.012835233 5.512596e-05 0.002532943 2111.244 0.9987392</span>
<span id="cb29-14"><a href="#cb29-14"></a>beta_age[4] -0.006920516 1.579955e-04 0.009694929 3765.301 0.9990227</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<div class="cell" data-output.var="">
<div class="sourceCode cell-code" id="cb30" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of observations</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of age pieces</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; I_age;</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matrix of ages</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N,I_age] age;</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of other predictors</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; I;</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matrix of other predictors</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N,I] X;</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of groups</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; J;</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Groups</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=J&gt; jj[N];</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Outcomes</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">4</span>&gt;[N] gpa;</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Intercept</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficients of age</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[I_age] beta_age;</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficients of other predictors</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[I] beta;</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Group-level intercepts</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[J] gamma;</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of errors</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of group-level intercepts</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_gamma;</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>  alpha ~ normal(<span class="dv">3</span>, <span class="dv">1</span>);</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>  beta_age ~ std_normal();</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>  beta ~ std_normal();</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>  gamma ~ std_normal();</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>  sigma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>  sigma_gamma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Model</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>  gpa ~ normal(alpha +</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>               (age * beta_age) +</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>               (X * beta) +</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>               (gamma[jj] * sigma_gamma),</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>               sigma);</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="interpreting-the-age-parameters-1" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-the-age-parameters-1">Interpreting the age parameters</h2>
<p>The parameters of a piecewise linear regression are like the parameters of a simple linear regression, except that there are more of them. This fitted model estimates that GPA decreases by about 0.3 points per year up until age 18, increases by about 0.05 points per year from 18 to 23, increases by about 0.01 points per year from 23 to 45, and decreases by about 0.01 points per year thereafter.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the ages we want to plot and their corresponding predictors.</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>ages <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(students<span class="sc">$</span>age), <span class="fu">max</span>(students<span class="sc">$</span>age), <span class="fl">0.1</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>age.pieces <span class="ot">=</span> <span class="fu">cbind</span>(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmin</span>(ages, <span class="dv">18</span>),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">if_else</span>(ages <span class="sc">&lt;=</span> <span class="dv">18</span>, <span class="dv">0</span>, <span class="fu">pmin</span>(ages, <span class="dv">23</span>) <span class="sc">-</span> <span class="dv">18</span>),</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">if_else</span>(ages <span class="sc">&lt;=</span> <span class="dv">23</span>, <span class="dv">0</span>, <span class="fu">pmin</span>(ages, <span class="dv">45</span>) <span class="sc">-</span> <span class="dv">23</span>),</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">if_else</span>(ages <span class="sc">&lt;=</span> <span class="dv">45</span>, <span class="dv">0</span>, ages <span class="sc">-</span> <span class="dv">45</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a matrix of model predictors with one row per age.  All other</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co"># predictors are fixed at their mean values in the dataset.</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">apply</span>(<span class="fu">model.matrix</span>(piecewise.m), <span class="dv">2</span>, mean)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(X, <span class="fu">length</span>(ages)), <span class="at">nrow =</span> <span class="fu">length</span>(ages), <span class="at">byrow =</span> T)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>X[,<span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"^age"</span>, <span class="fu">names</span>(<span class="fu">fixef</span>(piecewise.m))))] <span class="ot">=</span> age.pieces</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the fixed-effects coefficients and their covariance matrix.</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">fixef</span>(piecewise.m)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>covs <span class="ot">=</span> <span class="fu">vcov</span>(piecewise.m)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the smallest degrees of freedom estimated by `lmerTest`.</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">min</span>(<span class="fu">summary</span>(piecewise.m)<span class="sc">$</span>coefficients[,<span class="st">"df"</span>])</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Run 10,000 simulations.  In each simulation, sample coefficient values from</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="co"># the multivariate t distribution and use those to get the predicted GPA.</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate across simulations to get a mean estimate and confidence interval</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="co"># for each age.</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>piecewise.preds <span class="ot">=</span> <span class="fu">map_dfr</span>(</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>,</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(sim) {</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    sim.coefs <span class="ot">=</span> <span class="fu">t</span>(<span class="fu">rmvt</span>(<span class="dv">1</span>, coefs, covs <span class="sc">*</span> (df <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">/</span> df, df))</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">age =</span> ages,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gpa =</span> (X <span class="sc">%*%</span> sim.coefs)[,<span class="dv">1</span>]))</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"sim"</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age) <span class="sc">%&gt;%</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">lower.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.025</span>),</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>            <span class="at">lower.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.25</span>),</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.75</span>),</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.975</span>),</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>            <span class="at">gpa =</span> <span class="fu">mean</span>(gpa),</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Model prediction"</span>)</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Add observed raw means by age for plotting.</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>piecewise.preds <span class="ot">=</span> piecewise.preds <span class="sc">%&gt;%</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(students <span class="sc">%&gt;%</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(age) <span class="sc">%&gt;%</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarise</span>(<span class="at">gpa =</span> <span class="fu">mean</span>(gpa), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Raw mean"</span>))</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot model predictions and raw means.</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>piecewise.preds <span class="sc">%&gt;%</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> gpa, <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> students, <span class="at">color =</span> <span class="st">"gray60"</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.95</span>, <span class="at">ymax =</span> upper<span class="fl">.95</span>),</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.50</span>, <span class="at">ymax =</span> upper<span class="fl">.50</span>),</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"red4"</span>)) <span class="sc">+</span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"lightblue1"</span>, <span class="cn">NA</span>),</span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>                    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="fu">dsa.colors</span>(<span class="dv">3</span>), <span class="st">"white"</span>)))) <span class="sc">+</span></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"GPA"</span>, <span class="at">color =</span> <span class="st">""</span>, <span class="at">fill =</span> <span class="st">""</span>,</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Age as a piecewise linear predictor"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/piecewise_preds_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is looking more plausible than any of the other models we’ve tried so far. Not perfect – a single breakpoint at age 18 clearly doesn’t do justice to whatever is going on for the youngest students. But it’s an improvement.</p>
</section>
<section id="fitting-the-model-plus-breakpoints-1" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-model-plus-breakpoints-1">Fitting the model plus breakpoints</h2>
<p>As with the binned model, we might want to fit the breakpoints in addition to fitting the coefficients for the associated predictors. The <code>segmented()</code> function (also from the <code>segmented</code> package) lets us do this. The arguments are the same as those for <code>stepmented()</code>, except that this time we want to include <code>age</code> as one of the predictors in the base model (so that the first segment gets a slope).</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true" href="">R code</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false" href="">Stan code in R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-3" role="tab" aria-controls="tabset-5-3" aria-selected="false" href="">Stan model</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb32" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>piecewise.breaks.m <span class="ot">=</span> <span class="fu">segmented</span>(<span class="fu">lm</span>(gpa <span class="sc">~</span> planet <span class="sc">+</span> lefty <span class="sc">+</span> age,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">data =</span> students),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">seg.Z =</span> <span class="sc">~</span> age, <span class="at">npsi =</span> <span class="dv">3</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(piecewise.breaks.m)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11-17">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb33" data-output-line-numbers="11-17" data-code-line-numbers="11-17"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb33-1"><a href="#cb33-1"></a>                 Estimate  Std. Error    t value      Pr(&gt;|t|)</span>
<span id="cb33-2"><a href="#cb33-2"></a>(Intercept)    8.65477033 0.349872029  24.736960 5.533342e-133</span>
<span id="cb33-3"><a href="#cb33-3"></a>planetSaturn  -0.37671472 0.024118276 -15.619471  6.599347e-55</span>
<span id="cb33-4"><a href="#cb33-4"></a>planetUranus  -0.19545859 0.047619140  -4.104622  2.034616e-05</span>
<span id="cb33-5"><a href="#cb33-5"></a>planetNeptune -0.13593453 0.048497021  -2.802946  2.534860e-03</span>
<span id="cb33-6"><a href="#cb33-6"></a>planetEarth   -0.05794630 0.056079080  -1.033296  1.507402e-01</span>
<span id="cb33-7"><a href="#cb33-7"></a>planetVenus   -0.60187958 0.058910621 -10.216826  9.855576e-25</span>
<span id="cb33-8"><a href="#cb33-8"></a>planetMars    -0.52357744 0.093365223  -5.607842  1.040744e-08</span>
<span id="cb33-9"><a href="#cb33-9"></a>planetMercury -0.40114116 0.128635389  -3.118436  9.106333e-04</span>
<span id="cb33-10"><a href="#cb33-10"></a>leftyTRUE     -0.10694707 0.023175774  -4.614606  1.984027e-06</span>
<span id="cb33-11"><a href="#cb33-11"></a>age           -0.32732355 0.020448168 -16.007475  1.528176e-57</span>
<span id="cb33-12"><a href="#cb33-12"></a>U1.age         0.40924487 0.023421835  17.472793  4.700828e-68</span>
<span id="cb33-13"><a href="#cb33-13"></a>U2.age        -0.06761044 0.012372122  -5.464741  2.351499e-08</span>
<span id="cb33-14"><a href="#cb33-14"></a>U3.age        -0.01096138 0.009518782  -1.151553  1.247608e-01</span>
<span id="cb33-15"><a href="#cb33-15"></a>psi1.age       0.00000000 0.102250502   0.000000  1.000000e+00</span>
<span id="cb33-16"><a href="#cb33-16"></a>psi2.age       0.00000000 0.697008351   0.000000  1.000000e+00</span>
<span id="cb33-17"><a href="#cb33-17"></a>psi3.age       0.00000000 8.616707144   0.000000  1.000000e+00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb34" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the data for Stan.</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>piecewise.breaks.stan.data <span class="ot">=</span> <span class="fu">with</span>(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">df =</span> students <span class="sc">%&gt;%</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">5000</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">nrow</span>(df),</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">I_age =</span> <span class="dv">3</span>,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> df<span class="sc">$</span>age,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> planet <span class="sc">+</span> lefty, <span class="at">data =</span> df)[,<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">jj =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(df<span class="sc">$</span>major)),</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">gpa =</span> df<span class="sc">$</span>gpa</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>piecewise.breaks.stan.data<span class="sc">$</span>I <span class="ot">=</span> <span class="fu">ncol</span>(piecewise.breaks.stan.data<span class="sc">$</span>X)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>piecewise.breaks.stan.data<span class="sc">$</span>J <span class="ot">=</span> <span class="fu">max</span>(piecewise.breaks.stan.data<span class="sc">$</span>jj)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.  Breakpoints are implemented as a discrete predictor (at</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="co"># integer values of age), similar to the changepoint model described at</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="co"># https://mc-stan.org/docs/stan-users-guide/latent-discrete.html#change-point.section.</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="co"># The number of parameters grows quadratically with the number of observations</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="co"># and exponentially with the number of breakpoints; for computational</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="co"># tractability, this example fits a model with just two breakpoints to a subset</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="co"># of the data.</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>piecewise.breaks.stan <span class="ot">=</span> <span class="fu">stan</span>(<span class="st">"piecewise_breaks.stan"</span>,</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> piecewise.breaks.stan.data,</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>                             <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"beta_age"</span>, <span class="st">"gamma"</span>,</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"sigma"</span>, <span class="st">"sigma_gamma"</span>, <span class="st">"breakpoints"</span>),</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>                             <span class="at">chains =</span> <span class="dv">3</span>, <span class="at">iter =</span> <span class="dv">1000</span>)</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(piecewise.breaks.stan,</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"beta_age"</span>, <span class="st">"breakpoints"</span>),</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">probs =</span> <span class="fu">c</span>())<span class="sc">$</span>summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11-15">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb35" data-output-line-numbers="11-15" data-code-line-numbers="11-15"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb35-1"><a href="#cb35-1"></a>                      mean      se_mean         sd       n_eff      Rhat</span>
<span id="cb35-2"><a href="#cb35-2"></a>alpha           4.11590181 0.3446172912 0.45486534    1.742174 2.5369633</span>
<span id="cb35-3"><a href="#cb35-3"></a>beta[1]        -0.30103615 0.0008880694 0.04334901 2382.673625 1.0000652</span>
<span id="cb35-4"><a href="#cb35-4"></a>beta[2]        -0.10081436 0.0018146355 0.08442947 2164.757948 1.0015772</span>
<span id="cb35-5"><a href="#cb35-5"></a>beta[3]        -0.14154265 0.0014194617 0.08347920 3458.670622 0.9986489</span>
<span id="cb35-6"><a href="#cb35-6"></a>beta[4]         0.06944779 0.0104698739 0.10448141   99.585285 1.0269694</span>
<span id="cb35-7"><a href="#cb35-7"></a>beta[5]        -0.46446943 0.0018705027 0.10004834 2860.903092 0.9988476</span>
<span id="cb35-8"><a href="#cb35-8"></a>beta[6]        -0.24347529 0.0026816465 0.15863444 3499.386534 1.0013195</span>
<span id="cb35-9"><a href="#cb35-9"></a>beta[7]        -0.12918422 0.0040611816 0.22044018 2946.298177 0.9996007</span>
<span id="cb35-10"><a href="#cb35-10"></a>beta[8]        -0.07629417 0.0101983123 0.04300679   17.783504 1.0553716</span>
<span id="cb35-11"><a href="#cb35-11"></a>beta_age[1]    -0.23491546 0.1181986685 0.14990239    1.608392 3.6434904</span>
<span id="cb35-12"><a href="#cb35-12"></a>beta_age[2]    -0.17034742 0.2556815768 0.31490504    1.516912 9.3155317</span>
<span id="cb35-13"><a href="#cb35-13"></a>beta_age[3]     0.01205343 0.0074219912 0.01178885    2.522910 1.5200881</span>
<span id="cb35-14"><a href="#cb35-14"></a>breakpoints[1] 17.66666667          NaN 0.47156173         NaN       Inf</span>
<span id="cb35-15"><a href="#cb35-15"></a>breakpoints[2] 23.95333333          NaN 5.13907537         NaN 1.8707740</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-5-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-3-tab">
<div class="cell" data-output.var="">
<div class="sourceCode cell-code" id="cb36" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of observations</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of age pieces</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; I_age;</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Array of ages</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> age[N];</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of other predictors</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; I;</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matrix of other predictors</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N,I] X;</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of groups</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; J;</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Groups</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=J&gt; jj[N];</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Outcomes</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">4</span>&gt;[N] gpa;</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of age breakpoints</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N_breakpoints = I_age - <span class="dv">1</span>;</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Limits and size of age range</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> age_min = min(age) - <span class="dv">1</span>;</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> age_max = max(age);</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> age_range = age_max - age_min;</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Age reset to start at 1</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=age_range&gt; age_reset[N];</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of possible combinations of breakpoint values (with the restriction</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">// that successive breakpoints must be non-decreasing)</span></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N_combos = falling_factorial(age_range, N_breakpoints) / <span class="dv">2</span>;</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> log_unif = -log(N_combos);</span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Breakpoint values that correspond to each element in the lp vector</span></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=age_range&gt; inds_bp[N_combos,N_breakpoints];</span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number and indices of observations greater than each age</span></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=N&gt; N_age_gt[age_range] = rep_array(<span class="dv">0</span>, age_range);</span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=N&gt; inds_age_gt[age_range,N] = rep_array(<span class="dv">0</span>, age_range, N);</span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Populate breakpoint values</span></span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep track of which combination of breakpoint values we're working with;</span></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">// start with all breakpoints set to 1 (= smallest age in dataset)</span></span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> inds_age[N_breakpoints] = rep_array(<span class="dv">1</span>, N_breakpoints);</span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Iterate over all possible combinations of breakpoint values</span></span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span>:N_combos) {</span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Record the value of this breakpoint</span></span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a>      inds_bp[i,] = inds_age;</span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Increment breakpoint values: increase the last breakpoint by 1, unless</span></span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a>      <span class="co">// it's already at the maximum, in which case reset the last breakpoint to</span></span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a>      <span class="co">// 1 and increase the second-to-last breakpoint by 1, unless it's already</span></span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a>      <span class="co">// at the maximum, in which case repeat until we find a breakpoint that</span></span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a>      <span class="co">// can be increased</span></span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(b <span class="cf">in</span> <span class="dv">1</span>:N_breakpoints) {</span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> rev_b = N_breakpoints - b + <span class="dv">1</span>;</span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(inds_age[rev_b] &lt; age_range) {</span>
<span id="cb36-74"><a href="#cb36-74" aria-hidden="true" tabindex="-1"></a>          inds_age[rev_b] += <span class="dv">1</span>;</span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(rev_b &lt; N_breakpoints) {</span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span>(b2 <span class="cf">in</span> (rev_b+<span class="dv">1</span>):N_breakpoints) {</span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a>              inds_age[b2] = inds_age[b2<span class="dv">-1</span>];</span>
<span id="cb36-78"><a href="#cb36-78" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb36-79"><a href="#cb36-79" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb36-80"><a href="#cb36-80" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span>;</span>
<span id="cb36-81"><a href="#cb36-81" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb36-82"><a href="#cb36-82" aria-hidden="true" tabindex="-1"></a>          inds_age[rev_b] = <span class="dv">1</span>;</span>
<span id="cb36-83"><a href="#cb36-83" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb36-84"><a href="#cb36-84" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb36-85"><a href="#cb36-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-86"><a href="#cb36-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-87"><a href="#cb36-87" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-88"><a href="#cb36-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-89"><a href="#cb36-89" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Populate observation age indices</span></span>
<span id="cb36-90"><a href="#cb36-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb36-91"><a href="#cb36-91" aria-hidden="true" tabindex="-1"></a>    age_reset[n] = age[n] - age_min;</span>
<span id="cb36-92"><a href="#cb36-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(age_ind <span class="cf">in</span> <span class="dv">1</span>:(age_reset[n]-<span class="dv">1</span>)) {</span>
<span id="cb36-93"><a href="#cb36-93" aria-hidden="true" tabindex="-1"></a>      N_age_gt[age_ind] += <span class="dv">1</span>;</span>
<span id="cb36-94"><a href="#cb36-94" aria-hidden="true" tabindex="-1"></a>      inds_age_gt[age_ind,N_age_gt[age_ind]] = n;</span>
<span id="cb36-95"><a href="#cb36-95" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-96"><a href="#cb36-96" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-97"><a href="#cb36-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-98"><a href="#cb36-98" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-99"><a href="#cb36-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-100"><a href="#cb36-100" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb36-101"><a href="#cb36-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-102"><a href="#cb36-102" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Intercept</span></span>
<span id="cb36-103"><a href="#cb36-103" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb36-104"><a href="#cb36-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-105"><a href="#cb36-105" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficients of age pieces</span></span>
<span id="cb36-106"><a href="#cb36-106" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[I_age] beta_age;</span>
<span id="cb36-107"><a href="#cb36-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-108"><a href="#cb36-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficients of other predictors</span></span>
<span id="cb36-109"><a href="#cb36-109" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[I] beta;</span>
<span id="cb36-110"><a href="#cb36-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-111"><a href="#cb36-111" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Group-level intercepts</span></span>
<span id="cb36-112"><a href="#cb36-112" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[J] base_gamma;</span>
<span id="cb36-113"><a href="#cb36-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-114"><a href="#cb36-114" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of errors</span></span>
<span id="cb36-115"><a href="#cb36-115" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb36-116"><a href="#cb36-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-117"><a href="#cb36-117" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of group-level intercepts</span></span>
<span id="cb36-118"><a href="#cb36-118" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_gamma;</span>
<span id="cb36-119"><a href="#cb36-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-120"><a href="#cb36-120" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-121"><a href="#cb36-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-122"><a href="#cb36-122" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb36-123"><a href="#cb36-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-124"><a href="#cb36-124" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scaled group-level intercepts</span></span>
<span id="cb36-125"><a href="#cb36-125" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[J] gamma = base_gamma * sigma_gamma;</span>
<span id="cb36-126"><a href="#cb36-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-127"><a href="#cb36-127" aria-hidden="true" tabindex="-1"></a>  <span class="co">// All predictors except later age segments</span></span>
<span id="cb36-128"><a href="#cb36-128" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] mu = alpha +</span>
<span id="cb36-129"><a href="#cb36-129" aria-hidden="true" tabindex="-1"></a>                 (X * beta) +</span>
<span id="cb36-130"><a href="#cb36-130" aria-hidden="true" tabindex="-1"></a>                 (gamma[jj] * sigma_gamma) +</span>
<span id="cb36-131"><a href="#cb36-131" aria-hidden="true" tabindex="-1"></a>                 (to_vector(age_reset) * beta_age[<span class="dv">1</span>]);</span>
<span id="cb36-132"><a href="#cb36-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-133"><a href="#cb36-133" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Accumulate log p when discrete parameters are marginalized out</span></span>
<span id="cb36-134"><a href="#cb36-134" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N_combos] lp = rep_vector(log_unif, N_combos);</span>
<span id="cb36-135"><a href="#cb36-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-136"><a href="#cb36-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Iterate over all possible combinations of breakpoint values</span></span>
<span id="cb36-137"><a href="#cb36-137" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span>:N_combos) {</span>
<span id="cb36-138"><a href="#cb36-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-139"><a href="#cb36-139" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the values of the breakpoints for this combination</span></span>
<span id="cb36-140"><a href="#cb36-140" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> bps[N_breakpoints] = inds_bp[i,];</span>
<span id="cb36-141"><a href="#cb36-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-142"><a href="#cb36-142" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the mus computed so far</span></span>
<span id="cb36-143"><a href="#cb36-143" aria-hidden="true" tabindex="-1"></a>    <span class="dt">vector</span>[N] temp_mu = mu;</span>
<span id="cb36-144"><a href="#cb36-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-145"><a href="#cb36-145" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Iterate over breakpoints</span></span>
<span id="cb36-146"><a href="#cb36-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(b <span class="cf">in</span> <span class="dv">1</span>:N_breakpoints) {</span>
<span id="cb36-147"><a href="#cb36-147" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Useful counts and indices stored above</span></span>
<span id="cb36-148"><a href="#cb36-148" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> N_gt = N_age_gt[bps[b]];</span>
<span id="cb36-149"><a href="#cb36-149" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> gt_inds[N_gt] = inds_age_gt[bps[b],<span class="dv">1</span>:N_gt];</span>
<span id="cb36-150"><a href="#cb36-150" aria-hidden="true" tabindex="-1"></a>      <span class="co">// The value of the previous breakpoint, if there is one</span></span>
<span id="cb36-151"><a href="#cb36-151" aria-hidden="true" tabindex="-1"></a>      <span class="dt">real</span> prev_bp = <span class="dv">0</span>;</span>
<span id="cb36-152"><a href="#cb36-152" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(b &gt; <span class="dv">1</span>) {</span>
<span id="cb36-153"><a href="#cb36-153" aria-hidden="true" tabindex="-1"></a>        prev_bp = bps[b<span class="dv">-1</span>];</span>
<span id="cb36-154"><a href="#cb36-154" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb36-155"><a href="#cb36-155" aria-hidden="true" tabindex="-1"></a>      <span class="co">// For all ages greater than the value of this breakpoint, remove the</span></span>
<span id="cb36-156"><a href="#cb36-156" aria-hidden="true" tabindex="-1"></a>      <span class="co">// coefficient * parameter associated with the previous breakpoint and add</span></span>
<span id="cb36-157"><a href="#cb36-157" aria-hidden="true" tabindex="-1"></a>      <span class="co">// this one instead</span></span>
<span id="cb36-158"><a href="#cb36-158" aria-hidden="true" tabindex="-1"></a>      temp_mu[gt_inds] -= (to_vector(age_reset[gt_inds]) - prev_bp) *</span>
<span id="cb36-159"><a href="#cb36-159" aria-hidden="true" tabindex="-1"></a>                          beta_age[b];</span>
<span id="cb36-160"><a href="#cb36-160" aria-hidden="true" tabindex="-1"></a>      temp_mu[gt_inds] += (bps[b] - prev_bp) * beta_age[b];</span>
<span id="cb36-161"><a href="#cb36-161" aria-hidden="true" tabindex="-1"></a>      temp_mu[gt_inds] += (to_vector(age_reset[gt_inds]) - bps[b]) *</span>
<span id="cb36-162"><a href="#cb36-162" aria-hidden="true" tabindex="-1"></a>                          beta_age[b+<span class="dv">1</span>];</span>
<span id="cb36-163"><a href="#cb36-163" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-164"><a href="#cb36-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-165"><a href="#cb36-165" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add the computed mus for this element of log p</span></span>
<span id="cb36-166"><a href="#cb36-166" aria-hidden="true" tabindex="-1"></a>    lp[i] += normal_lpdf(gpa | temp_mu, sigma);</span>
<span id="cb36-167"><a href="#cb36-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-168"><a href="#cb36-168" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-169"><a href="#cb36-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-170"><a href="#cb36-170" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-171"><a href="#cb36-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-172"><a href="#cb36-172" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb36-173"><a href="#cb36-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-174"><a href="#cb36-174" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb36-175"><a href="#cb36-175" aria-hidden="true" tabindex="-1"></a>  alpha ~ normal(<span class="dv">3</span>, <span class="dv">1</span>);</span>
<span id="cb36-176"><a href="#cb36-176" aria-hidden="true" tabindex="-1"></a>  beta_age ~ std_normal();</span>
<span id="cb36-177"><a href="#cb36-177" aria-hidden="true" tabindex="-1"></a>  beta ~ std_normal();</span>
<span id="cb36-178"><a href="#cb36-178" aria-hidden="true" tabindex="-1"></a>  base_gamma ~ std_normal();</span>
<span id="cb36-179"><a href="#cb36-179" aria-hidden="true" tabindex="-1"></a>  sigma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb36-180"><a href="#cb36-180" aria-hidden="true" tabindex="-1"></a>  sigma_gamma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb36-181"><a href="#cb36-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-182"><a href="#cb36-182" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Model</span></span>
<span id="cb36-183"><a href="#cb36-183" aria-hidden="true" tabindex="-1"></a>  <span class="kw">target +=</span> log_sum_exp(lp);</span>
<span id="cb36-184"><a href="#cb36-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-185"><a href="#cb36-185" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-186"><a href="#cb36-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-187"><a href="#cb36-187" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span> {</span>
<span id="cb36-188"><a href="#cb36-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-189"><a href="#cb36-189" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Breakpoints</span></span>
<span id="cb36-190"><a href="#cb36-190" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=age_min+<span class="dv">1</span>,<span class="kw">upper</span>=age_max&gt; breakpoints[N_breakpoints];</span>
<span id="cb36-191"><a href="#cb36-191" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb36-192"><a href="#cb36-192" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> lp_ind = categorical_logit_rng(lp);</span>
<span id="cb36-193"><a href="#cb36-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(b <span class="cf">in</span> <span class="dv">1</span>:N_breakpoints) {</span>
<span id="cb36-194"><a href="#cb36-194" aria-hidden="true" tabindex="-1"></a>      breakpoints[b] = age_min + inds_bp[lp_ind,b];</span>
<span id="cb36-195"><a href="#cb36-195" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-196"><a href="#cb36-196" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-197"><a href="#cb36-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-198"><a href="#cb36-198" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>As before, we can find the estimated breakpoints in <code>piecewise.breaks.m$psi</code>:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>piecewise.breaks.m<span class="sc">$</span>psi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>         Initial     Est.    St.Err
psi1.age      NA 18.31286 0.1022505
psi2.age      NA 23.14319 0.6970084
psi3.age      NA 39.00000 8.6167071</code></pre>
</div>
</div>
</section>
<section id="interpreting-the-age-and-breakpoint-parameters-1" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-the-age-and-breakpoint-parameters-1">Interpreting the age and breakpoint parameters</h2>
<p>The <code>segmented()</code> function parameterizes the piecewise model differently from the example above, analogous to the <code>stepmented()</code> function: the coefficient for each segment is the difference in slope from the previous segment, not the absolute slope.</p>
<p><span class="math display">\[x_i(\mbox{age}) = \left\{\begin{array}{ll} 0 &amp; \mbox{if } \mbox{age} \leq \mbox{breakpoint}_i \\ \mbox{age} - \mbox{breakpoint}_i &amp; \mbox{if } \mbox{age} &gt; \mbox{breakpoint}_i \end{array}\right.\]</span></p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/piecewise_predictors_2-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The fitted model estimates that GPA decreases by about 0.327 points per year among the youngest students, increases by about -0.327 <code>+</code> <code>round(coef(piecewise.breaks.m)[["U1.age"]], 3)</code> = 0.082 points per year in the next age group (from approximately age 18.3 to age 23.1), and so on. As before, the estimated breakpoints come with some uncertainty:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>piecewise.breaks.m<span class="sc">$</span>psi <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">se =</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(piecewise.breaks.m)[<span class="fu">grepl</span>(<span class="st">"psi"</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                                                       <span class="fu">names</span>(<span class="fu">coef</span>(piecewise.breaks.m))),<span class="fu">grepl</span>(<span class="st">"psi"</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>                                                                                              <span class="fu">names</span>(<span class="fu">coef</span>(piecewise.breaks.m)))]))) <span class="sc">%&gt;%</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"i"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"^psi"</span>, i)) <span class="sc">%&gt;%</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">i =</span> <span class="fu">gsub</span>(<span class="st">"^psi([0-9]+).age$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, i),</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">i =</span> <span class="fu">as.factor</span>(<span class="fu">as.numeric</span>(i)),</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">lower.95 =</span> Est. <span class="sc">+</span> (<span class="fu">qnorm</span>(<span class="fl">0.025</span>) <span class="sc">*</span> se),</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">lower.50 =</span> Est. <span class="sc">+</span> (<span class="fu">qnorm</span>(<span class="fl">0.25</span>) <span class="sc">*</span> se),</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper.50 =</span> Est. <span class="sc">+</span> (<span class="fu">qnorm</span>(<span class="fl">0.75</span>) <span class="sc">*</span> se),</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">upper.95 =</span> Est. <span class="sc">+</span> (<span class="fu">qnorm</span>(<span class="fl">0.975</span>) <span class="sc">*</span> se)) <span class="sc">%&gt;%</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">fct_rev</span>(i))) <span class="sc">+</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower<span class="fl">.95</span>, <span class="at">xmax =</span> upper<span class="fl">.95</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower<span class="fl">.50</span>, <span class="at">xmax =</span> upper<span class="fl">.50</span>), <span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> Est.), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">range</span>(students<span class="sc">$</span>age)) <span class="sc">+</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Estimated value"</span>, <span class="at">y =</span> <span class="st">"Breakpoint"</span>, <span class="at">color =</span> <span class="st">"Breakpoint"</span>,</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Breakpoint"</span>) <span class="sc">+</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/piecewise_breaks_breakpoints-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The degree of uncertainty around a given breakpoint corresponds to the apparent sharpness of the break in that region of the age range when we plot marginal predicted outcomes by age. The fitted model is quite certain that the first breakpoint is almost exactly 18.3; the plot shows a very sharp change in slope at that point. The model is less certain about the precise location of the breakpoint around 23.1, and the change in slope is correspondingly spread out over a larger range of ages. Finally, the model has basically no idea where the last breakpoint should be, which means that the rest of the plotted predicted values look like a very gentle curve.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the ages we want to plot.</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>ages <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(students<span class="sc">$</span>age), <span class="fu">max</span>(students<span class="sc">$</span>age), <span class="fl">0.1</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a matrix of model predictors with one row per age.  All other</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># predictors are fixed at their mean values in the dataset.  The first age</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># predictor is just raw age; predictors for subsequent segments will be filled</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co"># in within individual simulations.</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">apply</span>(<span class="fu">model.matrix</span>(piecewise.breaks.m), <span class="dv">2</span>, mean)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> X[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"age$"</span>, <span class="fu">names</span>(X))]</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(X, <span class="fu">length</span>(ages)), <span class="at">nrow =</span> <span class="fu">length</span>(ages), <span class="at">byrow =</span> T)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">cbind</span>(X, ages)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the parameters and their covariance matrix.  Note which parameters are for</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co"># breakpoints (as opposed to being coefficients for predictors).</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">coef</span>(piecewise.breaks.m)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>covs <span class="ot">=</span> <span class="fu">vcov</span>(piecewise.breaks.m)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>breakpoint.ind <span class="ot">=</span> <span class="fu">grepl</span>(<span class="st">"^psi"</span>, <span class="fu">names</span>(coefs))</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>coefs[breakpoint.ind] <span class="ot">=</span> piecewise.breaks.m<span class="sc">$</span>psi[,<span class="st">"Est."</span>]</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the degrees of freedom.</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> piecewise.breaks.m<span class="sc">$</span>df.residual</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Run 10,000 simulations.  In each simulation, sample parameter values from</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="co"># the multivariate t distribution and use those to get the predicted GPA.</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate across simulations to get a mean estimate and confidence interval</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="co"># for each age.</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>piecewise.breaks.preds <span class="ot">=</span> <span class="fu">map_dfr</span>(</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>,</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(sim) {</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>    sim.coefs <span class="ot">=</span> <span class="fu">t</span>(<span class="fu">rmvt</span>(<span class="dv">1</span>, coefs, covs <span class="sc">*</span> (df <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">/</span> df, df))</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    sim.breakpoints <span class="ot">=</span> <span class="fu">cummax</span>(sim.coefs[breakpoint.ind])</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>    sim.X <span class="ot">=</span> <span class="fu">cbind</span>(X,</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">do.call</span>(</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"cbind"</span>,</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">lapply</span>(sim.breakpoints, <span class="cf">function</span>(b) { <span class="fu">pmax</span>(ages <span class="sc">-</span> b, <span class="dv">0</span>) })</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>                  ))</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">age =</span> ages,</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gpa =</span> (sim.X <span class="sc">%*%</span> sim.coefs[<span class="sc">!</span>breakpoint.ind])[,<span class="dv">1</span>]))</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"sim"</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age) <span class="sc">%&gt;%</span></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">lower.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.025</span>),</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>            <span class="at">lower.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.25</span>),</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.75</span>),</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.975</span>),</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>            <span class="at">gpa =</span> <span class="fu">mean</span>(gpa),</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Model prediction"</span>)</span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Add observed raw means by age for plotting.</span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>piecewise.breaks.preds <span class="ot">=</span> piecewise.breaks.preds <span class="sc">%&gt;%</span></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(students <span class="sc">%&gt;%</span></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(age) <span class="sc">%&gt;%</span></span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarise</span>(<span class="at">gpa =</span> <span class="fu">mean</span>(gpa), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Raw mean"</span>))</span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot model predictions and raw means.</span></span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>piecewise.breaks.preds <span class="sc">%&gt;%</span></span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> gpa, <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> students,</span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"gray60"</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.95</span>, <span class="at">ymax =</span> upper<span class="fl">.95</span>),</span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.50</span>, <span class="at">ymax =</span> upper<span class="fl">.50</span>),</span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"red4"</span>)) <span class="sc">+</span></span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"lightblue1"</span>, <span class="cn">NA</span>),</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>                    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="fu">dsa.colors</span>(<span class="dv">3</span>), <span class="st">"white"</span>)))) <span class="sc">+</span></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"GPA"</span>, <span class="at">color =</span> <span class="st">""</span>, <span class="at">fill =</span> <span class="st">""</span>,</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Age as a piecewise linear predictor with estimated breakpoints"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/piecewise_breaks_preds_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>For this dataset, these piecewise regressions are – at least impressionistically – a big improvement over the simple linear and binned models. They’re not perfect; in particular, we’re still not handling the youngest ages very well. (For a model with pre-specified breakpoints, we might consider including both 17 <em>and</em> 18 as breakpoints.)</p>
<p>The biggest red flag is the fact that the <code>segmented()</code> function has no idea where the largest breakpoint should optimally be located. This suggests that, for students over 30, the relationship between age is neither strictly linear nor a simple combination of linear pieces with a clear break between them. The curve in the plot of the marginal estimates is artificial (remember that it represents an aggregation over many underlying non-curvy models), but it also looks pretty good. Is there a way to model this relationship as a curve directly? Of course there is.</p>
</section>
</section>
<section id="splines" class="level1">
<h1>Splines</h1>
<p>Straight lines are mathematically easy. Certain kinds of curves (e.g., squares or logarithms) are also mathematically easy. Arbitrary curves are hard. Fortunately, splines are here to help.</p>
<p>A spline, basically, is a wiggly curve that’s created by adding together several smaller components. (They’re similar to Fourier analysis, where you can represent an arbitrarily complex wave as the sum of many simple sine waves – but splines use polynomial functions instead of trigonometric ones.) The maximum wiggliness of a spline is determined by two things: the degree of its component polynomial functions, and the number of knots at which adjacent functions join together. You get to choose both of these things when you create your spline, and you may want to experiment with different options. Too little wiggliness and the model won’t fit your data very well; too much, and the model won’t know what to do with the extra pieces (leading to non-convergence, overfitting, or undesirable correlations among your fitted parameters.)</p>
<section id="structure-of-predictors-3" class="level2">
<h2 class="anchored" data-anchor-id="structure-of-predictors-3">Structure of predictors</h2>
<p>We’re going to construct our splines out of “basis splines” (B-splines). B-splines are polynomial functions defined recursively as the sum of lower-order polynomials. For a spline of degree <span class="math inline">\(d\)</span> with <span class="math inline">\(k\)</span> knots, there are <span class="math inline">\(d + k\)</span> B-splines. For example, a cubic spline (degree 3) with 5 knots has 8 B-splines.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/splines_even_predictors-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>There’s no rule that says knots have to be spaced evenly. One common approach is to put the knots at quantiles of the observed distribution, which permits more wiggliness in the regions where you have more data.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/splines_quantile_predictors-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Just like in the previous examples, the overall relationship between age and outcome is determined by the sum of each of the age-related predictors multiplied by its fitted coefficient. Since the predictors in spline regression are curves, the relationship between age and outcome is a curve too.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/spline_relationships-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fitting-the-model-3" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-model-3">Fitting the model</h2>
<p>Computing B-splines isn’t too conceptually difficult (see <a href="https://mc-stan.org/learn-stan/case-studies/splines_in_stan.html">Milad Kharratzadeh’s guide to spline regression</a> for a good illustration), but it’s definitely tedious. It’s much easier to let the <code>splines</code> package do the work for us. First, we use the <code>bs()</code> function to construct B-splines over the age range in our dataset. The first argument to <code>bs()</code> is <code>students$age</code> – that is, a vector of all the observations of <code>age</code> in our dataset. We also specify the <code>degree</code> (3 for cubic splines) and <code>df</code> (total number of B-splines, equal to <code>degree</code> plus the number of knots we want). <code>bs()</code> will automatically put knots at the quantiles of the data. Instead of specifying <code>df</code>, we could instead provide <code>knots</code>, a vector of knots at whatever locations we choose.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>splines.bs <span class="ot">=</span> <span class="fu">bs</span>(students<span class="sc">$</span>age, <span class="at">degree =</span> <span class="dv">3</span>, <span class="at">df =</span> <span class="dv">8</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">cbind</span>(students<span class="sc">$</span>age, splines.bs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>        1 2 3         4           5          6            7         8
[1,] 44 0 0 0 0.0000000 0.081658692 0.34584475 0.4357850924 0.1367115
[2,] 22 0 0 0 0.3968254 0.588888889 0.01428571 0.0000000000 0.0000000
[3,] 22 0 0 0 0.3968254 0.588888889 0.01428571 0.0000000000 0.0000000
[4,] 23 0 0 0 0.2031746 0.751242690 0.04544420 0.0001385042 0.0000000
[5,] 53 0 0 0 0.0000000 0.006838118 0.09490012 0.4091836576 0.4890781
[6,] 23 0 0 0 0.2031746 0.751242690 0.04544420 0.0001385042 0.0000000</code></pre>
</div>
</div>
<p>The <code>bs()</code> function returns a matrix with one row for each observation in our dataset and one column for each B-spline. The value of each cell is the value of that B-spline for that observation. Now we can include the output of <code>bs()</code> as predictors in an ordinary linear regression.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true" href="">R code</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false" href="">Stan code in R</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-3" role="tab" aria-controls="tabset-6-3" aria-selected="false" href="">Stan model</a></li></ul>
<div class="tab-content">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb43" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>splines.m <span class="ot">=</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(gpa <span class="sc">~</span> planet <span class="sc">+</span> lefty <span class="sc">+</span> splines.bs <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> major),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">data =</span> students)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(splines.m)<span class="sc">$</span>coefficients</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11-18">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb44" data-output-line-numbers="11-18" data-code-line-numbers="11-18"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb44-1"><a href="#cb44-1"></a>                 Estimate Std. Error       df     t value      Pr(&gt;|t|)</span>
<span id="cb44-2"><a href="#cb44-2"></a>(Intercept)    3.59339461 0.16699315 10387.44  21.5182159 1.613376e-100</span>
<span id="cb44-3"><a href="#cb44-3"></a>planetSaturn  -0.34197793 0.02390388 16491.17 -14.3063755  3.771208e-46</span>
<span id="cb44-4"><a href="#cb44-4"></a>planetUranus  -0.17808174 0.04679331 16442.98  -3.8057095  1.419108e-04</span>
<span id="cb44-5"><a href="#cb44-5"></a>planetNeptune -0.11586889 0.04776968 16442.23  -2.4255740  1.529489e-02</span>
<span id="cb44-6"><a href="#cb44-6"></a>planetEarth   -0.03891083 0.05508656 16435.21  -0.7063579  4.799756e-01</span>
<span id="cb44-7"><a href="#cb44-7"></a>planetVenus   -0.55908575 0.05802919 16442.79  -9.6345605  6.528420e-22</span>
<span id="cb44-8"><a href="#cb44-8"></a>planetMars    -0.47915180 0.09186967 16434.08  -5.2155602  1.854859e-07</span>
<span id="cb44-9"><a href="#cb44-9"></a>planetMercury -0.39145022 0.12651791 16437.33  -3.0940300  1.977888e-03</span>
<span id="cb44-10"><a href="#cb44-10"></a>leftyTRUE     -0.06274829 0.02305699 16474.71  -2.7214434  6.506580e-03</span>
<span id="cb44-11"><a href="#cb44-11"></a>splines.bs1   -0.80349872 0.25170868 16396.30  -3.1921773  1.414710e-03</span>
<span id="cb44-12"><a href="#cb44-12"></a>splines.bs2    0.36711152 0.16221229 16398.28   2.2631549  2.363916e-02</span>
<span id="cb44-13"><a href="#cb44-13"></a>splines.bs3   -1.24837730 0.17172499 16405.51  -7.2696311  3.767093e-13</span>
<span id="cb44-14"><a href="#cb44-14"></a>splines.bs4   -0.60591530 0.16438645 16400.64  -3.6859199  2.286122e-04</span>
<span id="cb44-15"><a href="#cb44-15"></a>splines.bs5   -0.58525972 0.16718891 16404.24  -3.5005894  4.654632e-04</span>
<span id="cb44-16"><a href="#cb44-16"></a>splines.bs6   -0.38767412 0.20169888 16437.14  -1.9220440  5.461749e-02</span>
<span id="cb44-17"><a href="#cb44-17"></a>splines.bs7   -0.21935783 0.25560097 16457.84  -0.8582042  3.907922e-01</span>
<span id="cb44-18"><a href="#cb44-18"></a>splines.bs8   -0.38358757 0.23916947 16488.84  -1.6038316  1.087703e-01</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb45" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the data for Stan.  This example saves the B-splines in R and feeds</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># them into Stan; alternatively, it's possible to compute B-splines within Stan</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># itself.</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>splines.stan.data <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(students),</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">age =</span> students<span class="sc">$</span>age,</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">degree =</span> <span class="dv">3</span>,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">basis_splines =</span> splines.bs,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> planet <span class="sc">+</span> lefty, <span class="at">data =</span> students)[,<span class="sc">-</span><span class="dv">1</span>],</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">jj =</span> <span class="fu">as.numeric</span>(<span class="fu">as.factor</span>(students<span class="sc">$</span>major)),</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">gpa =</span> students<span class="sc">$</span>gpa</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>splines.stan.data<span class="sc">$</span>I_basis <span class="ot">=</span> <span class="fu">ncol</span>(splines.stan.data<span class="sc">$</span>basis_splines)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>splines.stan.data<span class="sc">$</span>I <span class="ot">=</span> <span class="fu">ncol</span>(splines.stan.data<span class="sc">$</span>X)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>splines.stan.data<span class="sc">$</span>J <span class="ot">=</span> <span class="fu">max</span>(splines.stan.data<span class="sc">$</span>jj)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model.</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>splines.stan <span class="ot">=</span> <span class="fu">stan</span>(<span class="st">"splines.stan"</span>, <span class="at">data =</span> splines.stan.data,</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>                    <span class="at">chains =</span> <span class="dv">3</span>, <span class="at">iter =</span> <span class="dv">1000</span>)</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarize the fitted parameters.</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(splines.stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"beta_age"</span>),</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">probs =</span> <span class="fu">c</span>())<span class="sc">$</span>summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output-line-numbers="11-18">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb46" data-output-line-numbers="11-18" data-code-line-numbers="11-18"><pre class="sourceCode numberSource highlight numberLines code-with-copy"><code class="sourceCode"><span id="cb46-1"><a href="#cb46-1"></a>                   mean      se_mean         sd     n_eff      Rhat</span>
<span id="cb46-2"><a href="#cb46-2"></a>alpha        3.48879222 0.0103407493 0.15113666  213.6169 1.0111432</span>
<span id="cb46-3"><a href="#cb46-3"></a>beta[1]     -0.34283808 0.0005874777 0.02389810 1654.7935 0.9990823</span>
<span id="cb46-4"><a href="#cb46-4"></a>beta[2]     -0.17647621 0.0010485971 0.04484337 1828.8550 0.9995961</span>
<span id="cb46-5"><a href="#cb46-5"></a>beta[3]     -0.11592445 0.0010573257 0.04827044 2084.2262 0.9984714</span>
<span id="cb46-6"><a href="#cb46-6"></a>beta[4]     -0.03849528 0.0013280932 0.05425456 1668.8428 0.9998451</span>
<span id="cb46-7"><a href="#cb46-7"></a>beta[5]     -0.55862624 0.0013619462 0.05681803 1740.4135 1.0011139</span>
<span id="cb46-8"><a href="#cb46-8"></a>beta[6]     -0.47155853 0.0018847661 0.09075863 2318.7876 0.9988067</span>
<span id="cb46-9"><a href="#cb46-9"></a>beta[7]     -0.38784167 0.0024617861 0.12856561 2727.4012 0.9988739</span>
<span id="cb46-10"><a href="#cb46-10"></a>beta[8]     -0.06332162 0.0004797674 0.02270165 2238.9964 0.9997913</span>
<span id="cb46-11"><a href="#cb46-11"></a>beta_age[1] -0.65190298 0.0139270868 0.23154832  276.4157 1.0072072</span>
<span id="cb46-12"><a href="#cb46-12"></a>beta_age[2]  0.44801731 0.0093311283 0.14946846  256.5847 1.0114957</span>
<span id="cb46-13"><a href="#cb46-13"></a>beta_age[3] -1.13677703 0.0108773277 0.15854118  212.4417 1.0118575</span>
<span id="cb46-14"><a href="#cb46-14"></a>beta_age[4] -0.50708251 0.0102420715 0.15105507  217.5179 1.0113931</span>
<span id="cb46-15"><a href="#cb46-15"></a>beta_age[5] -0.48206939 0.0104481223 0.15293338  214.2536 1.0112461</span>
<span id="cb46-16"><a href="#cb46-16"></a>beta_age[6] -0.28431778 0.0106713184 0.18826443  311.2436 1.0109537</span>
<span id="cb46-17"><a href="#cb46-17"></a>beta_age[7] -0.11955088 0.0104495337 0.23795361  518.5502 1.0008534</span>
<span id="cb46-18"><a href="#cb46-18"></a>beta_age[8] -0.27364919 0.0114492675 0.22620206  390.3352 1.0065462</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div id="tabset-6-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-3-tab">
<div class="cell" data-output.var="">
<div class="sourceCode cell-code" id="cb47" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> {</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of observations</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; N;</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Age</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[N] age;</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Degree of splines</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> degree;</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of basis splines</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> I_basis;</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matrix of basis splines</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N,I_basis] basis_splines;</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of other predictors</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; I;</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Matrix of other predictors</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[N,I] X;</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Number of groups</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; J;</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Groups</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>,<span class="kw">upper</span>=J&gt; jj[N];</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Outcomes</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>,<span class="kw">upper</span>=<span class="dv">4</span>&gt;[N] gpa;</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span> {</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Intercept</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficients of age splines</span></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[I_basis] beta_age;</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Coefficients of other predictors</span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[I] beta;</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Group-level intercepts</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[J] gamma;</span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of errors</span></span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma;</span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Scale of group-level intercepts</span></span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma_gamma;</span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span> {</span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Priors</span></span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a>  alpha ~ normal(<span class="dv">3</span>, <span class="dv">1</span>);</span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>  beta_age ~ std_normal();</span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>  beta ~ std_normal();</span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>  gamma ~ std_normal();</span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>  sigma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>  sigma_gamma ~ cauchy(<span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Model</span></span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a>  gpa ~ normal(alpha +</span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a>               (basis_splines * beta_age) +</span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a>               (X * beta) +</span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>               (gamma[jj] * sigma_gamma),</span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a>               sigma);</span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="interpreting-the-age-parameters-2" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-the-age-parameters-2">Interpreting the age parameters</h2>
<p>A big drawback of spline regression is that it’s exceedingly hard to interpret the coefficients of B-splines. The estimated coefficient of -0.803 for the first B-spline means something like “that curve multiplied by -0.803 contributes to the outcome” – which isn’t very helpful.</p>
<p>It’s much better to look at the shape of the overall spline as a whole. This is where our plots of the marginal effects of age come in especially handy. The relationship between age and GPA <em>is</em> that curve – it’s pretty much that simple.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the ages we want to plot and their corresponding predictors.</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>ages <span class="ot">=</span> <span class="fu">seq</span>(<span class="fu">min</span>(students<span class="sc">$</span>age), <span class="fu">max</span>(students<span class="sc">$</span>age), <span class="fl">0.1</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>ages.bs <span class="ot">=</span> <span class="fu">bs</span>(ages, <span class="at">degree =</span> <span class="dv">3</span>, <span class="at">knots =</span> <span class="fu">attr</span>(splines.bs, <span class="st">"knots"</span>))</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct a matrix of model predictors with one row per age.  All other</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co"># predictors are fixed at their mean values in the dataset.</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">apply</span>(<span class="fu">model.matrix</span>(splines.m), <span class="dv">2</span>, mean)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(X, <span class="fu">length</span>(ages)), <span class="at">nrow =</span> <span class="fu">length</span>(ages), <span class="at">byrow =</span> T)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>X[,<span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"^spline"</span>, <span class="fu">names</span>(<span class="fu">fixef</span>(splines.m))))] <span class="ot">=</span> ages.bs</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the fixed-effects coefficients and their covariance matrix.</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>coefs <span class="ot">=</span> <span class="fu">fixef</span>(splines.m)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>covs <span class="ot">=</span> <span class="fu">vcov</span>(splines.m)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the smallest degrees of freedom estimated by `lmerTest`.</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">min</span>(<span class="fu">summary</span>(splines.m)<span class="sc">$</span>coefficients[,<span class="st">"df"</span>])</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Run 10,000 simulations.  In each simulation, sample coefficient values from</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="co"># the multivariate t distribution and use those to get the predicted GPA.</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate across simulations to get a mean estimate and confidence interval</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="co"># for each age.</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>splines.preds <span class="ot">=</span> <span class="fu">map_dfr</span>(</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>,</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(sim) {</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>    sim.coefs <span class="ot">=</span> <span class="fu">t</span>(<span class="fu">rmvt</span>(<span class="dv">1</span>, coefs, covs <span class="sc">*</span> (df <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">/</span> df, df))</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">age =</span> ages,</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>                      <span class="at">gpa =</span> (X <span class="sc">%*%</span> sim.coefs)[,<span class="dv">1</span>]))</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">.id =</span> <span class="st">"sim"</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(age) <span class="sc">%&gt;%</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">lower.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.025</span>),</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">lower.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.25</span>),</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.50 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.75</span>),</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper.95 =</span> <span class="fu">quantile</span>(gpa, <span class="fl">0.975</span>),</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>            <span class="at">gpa =</span> <span class="fu">mean</span>(gpa),</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Model prediction"</span>)</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Add observed raw means by age for plotting.</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>splines.preds <span class="ot">=</span> splines.preds <span class="sc">%&gt;%</span></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(students <span class="sc">%&gt;%</span></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(age) <span class="sc">%&gt;%</span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarise</span>(<span class="at">gpa =</span> <span class="fu">mean</span>(gpa), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"Raw mean"</span>))</span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot model predictions and raw means.</span></span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>splines.preds <span class="sc">%&gt;%</span></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> gpa, <span class="at">color =</span> type)) <span class="sc">+</span></span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> students, <span class="at">color =</span> <span class="st">"gray60"</span>, <span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.95</span>, <span class="at">ymax =</span> upper<span class="fl">.95</span>),</span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">fill =</span> type, <span class="at">ymin =</span> lower<span class="fl">.50</span>, <span class="at">ymax =</span> upper<span class="fl">.50</span>),</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue"</span>, <span class="st">"red4"</span>)) <span class="sc">+</span></span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"lightblue1"</span>, <span class="cn">NA</span>),</span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a>                    <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="fu">dsa.colors</span>(<span class="dv">3</span>), <span class="st">"white"</span>)))) <span class="sc">+</span></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">4</span>)) <span class="sc">+</span></span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"GPA"</span>, <span class="at">color =</span> <span class="st">""</span>, <span class="at">fill =</span> <span class="st">""</span>,</span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Age splines as predictors"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="nonlinear_predictors_files/figure-html/spline_preds_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Computing marginal effects in this way helps us with another difficult aspect of spline regression. In a simple linear regression, if we want to do inference on age, we’re usually asking a question along the lines of “is there an effect of age?” This is equivalent to asking whether the estimated coefficient of age is reliably different from zero, and there are plenty of standard tools for helping us answer this question. But with splines, it’s less obvious what our questions might be. We might want to ask “does age predict GPA at all?”, which is basically the same question, and to answer the question we could explore whether <em>any</em> of the spline predictors have a coefficient that’s reliably different from zero. But the whole point of splines is that they allow us to regress on interesting shapes, which invites us to go beyond the question of “is there a shape?” to ask about specific properties of that shape.</p>
<p>The good news is that estimating marginal effects and their confidence intervals via simulation, as in the code above, is a powerful and flexible tool for asking many different kinds of questions. For example, we might ask “do 40-year-olds have reliably higher GPAs than 30-year-olds?” To answer this question, we run simulations as above, but instead of summarizing over each age individually, we summarize over the difference between the prediction for 40-year-olds and the prediction for 30-year-olds, and explore whether the confidence band for that difference includes zero. Alternatively, suppose we run a regression that fits separate splines for two groups (say, students in Major A and students in Major B). If we’re interested in whether the effect of age is different in the two majors, we run our simulations and compute the difference between Major A and Major B for each age; the summary will identify the ages (if any) at which estimated GPAs are reliably different.</p>
<p>All these things could be done for other types of models as well. The reason they’re especially helpful for splines is that the parameters by themselves are almost impossible to interpret in real-world terms.</p>
</section>
</section>
<section id="final-thoughts" class="level1">
<h1>Final thoughts</h1>
<p>Our model has come a long way. Impressionistically, the piecewise linear and spline regressions seem to do an especially good job of capturing the relationship between age and GPA in our dataset – but all of the tools discussed here have their uses. In fact, a quick look at AIC and BIC for the models we’ve fit so far suggest that the binned models perform surprisingly well (although this might change with more careful attention to how we model the youngest students):</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Refit the simple linear models without random effects, for a fairer comparison</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to the models produced by the `segmented` package.</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>linear.fixed.m <span class="ot">=</span> <span class="fu">lm</span>(gpa <span class="sc">~</span> planet <span class="sc">+</span> lefty <span class="sc">+</span> age,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> students)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>binned.fixed.m <span class="ot">=</span> <span class="fu">lm</span>(gpa <span class="sc">~</span> planet <span class="sc">+</span> lefty <span class="sc">+</span> age.bin,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> students <span class="sc">%&gt;%</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">mutate</span>(<span class="at">age.bin =</span> <span class="fu">case_when</span>(age <span class="sc">&lt;=</span> <span class="dv">17</span> <span class="sc">~</span> <span class="st">"17 and under"</span>,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>                                                 age <span class="sc">&lt;=</span> <span class="dv">22</span> <span class="sc">~</span> <span class="st">"18-22"</span>,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>                                                 age <span class="sc">&lt;=</span> <span class="dv">40</span> <span class="sc">~</span> <span class="st">"23-40"</span>,</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                                                 age <span class="sc">&lt;=</span> <span class="dv">50</span> <span class="sc">~</span> <span class="st">"41-50"</span>,</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>                                                 T <span class="sc">~</span> <span class="st">"51+"</span>),</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>                             <span class="at">age.bin =</span> <span class="fu">fct_reorder</span>(age.bin, age, mean)))</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>piecewise.fixed.m <span class="ot">=</span> <span class="fu">lm</span>(gpa <span class="sc">~</span> planet <span class="sc">+</span> lefty <span class="sc">+</span> age<span class="fl">.18</span> <span class="sc">+</span> age.<span class="fl">18.23</span> <span class="sc">+</span> age.<span class="fl">23.45</span> <span class="sc">+</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>                         age<span class="fl">.45</span>,</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> students <span class="sc">%&gt;%</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">mutate</span>(<span class="at">age.18 =</span> <span class="fu">pmin</span>(age, <span class="dv">18</span>),</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>                                <span class="at">age.18.23 =</span> <span class="fu">if_else</span>(age <span class="sc">&lt;=</span> <span class="dv">18</span>, <span class="dv">0</span>,</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>                                                    <span class="fu">pmin</span>(age, <span class="dv">23</span>) <span class="sc">-</span> <span class="dv">18</span>),</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>                                <span class="at">age.23.45 =</span> <span class="fu">if_else</span>(age <span class="sc">&lt;=</span> <span class="dv">23</span>, <span class="dv">0</span>,</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>                                                    <span class="fu">pmin</span>(age, <span class="dv">45</span>) <span class="sc">-</span> <span class="dv">23</span>),</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>                                <span class="at">age.45 =</span> <span class="fu">if_else</span>(age <span class="sc">&lt;=</span> <span class="dv">45</span>, <span class="dv">0</span>,</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>                                                 age <span class="sc">-</span> <span class="dv">45</span>)))</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>splines.fixed.m <span class="ot">=</span> <span class="fu">lm</span>(gpa <span class="sc">~</span> planet <span class="sc">+</span> lefty <span class="sc">+</span> splines.bs,</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> students)</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare goodness of fit for all the models so far.</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(performance)</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a><span class="fu">compare_performance</span>(linear.fixed.m, binned.fixed.m, binned.breaks.m,</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>                    piecewise.fixed.m, piecewise.breaks.m, splines.fixed.m,</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>                    <span class="at">metrics =</span> <span class="fu">c</span>(<span class="st">"AIC"</span>, <span class="st">"BIC"</span>, <span class="st">"R2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code># Comparison of Model Performance Indices

Name               |      Model |   AIC (weights) |   BIC (weights) |    R2
---------------------------------------------------------------------------
linear.fixed.m     |         lm | 54553.0 (&lt;.001) | 54637.8 (&lt;.001) | 0.036
binned.fixed.m     |         lm | 54049.0 (&lt;.001) | 54157.0 (&lt;.001) | 0.065
binned.breaks.m    | stepmented | 54017.5 (0.978) | 54140.9 (&gt;.999) | 0.067
piecewise.fixed.m  |         lm | 54140.3 (&lt;.001) | 54248.3 (&lt;.001) | 0.060
piecewise.breaks.m |  segmented | 54138.8 (&lt;.001) | 54269.9 (&lt;.001) | 0.061
splines.fixed.m    |         lm | 54025.1 (0.022) | 54164.0 (&lt;.001) | 0.067</code></pre>
</div>
</div>
<p>Models with strict breakpoints, like binning and piecewise regression, are especially well suited for situations where there’s a real-world explanation for the break. In this dataset, it’s obvious why there’s such a sharp turning point at age 18: that’s the age at which most students have just graduated from high school and become legal adults. Most students under 18 who are taking college classes are either enrolled in a concurrent program (and therefore part of a different population with different characteristics) or doing early college (again, a different population). By contrast, major life transitions later on are much more spread out; there’s wide variation in the age at which students get their first professional job, live on their own, have caregiving responsibilities, etc. It’s not surprising that we don’t see sharp transitions at older ages.</p>
<p>If the data calls for it, we can in principal combine different tools within the same analysis. The discussion so far has emphasized that all of these approaches reduce back down to ordinary linear regression, once you transform age into the necessary predictor(s). Nothing is stopping us from, for example, fitting one or two linear pieces to students under 18, and splines thereafter – as long as we’re careful to make sure the various pieces join up properly.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<script src="nonlinear_predictors_files/libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>